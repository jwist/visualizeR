'use strict';define(['jquery','src/header/components/default','src/util/versioning','forms/button','src/util/util','fancytree','components/ui-contextmenu/jquery.ui-contextmenu.min','jquery-ui/ui/widgets/dialog'],function(a,b,c,d,f){'use strict';function g(){}function h(j){return j.map(function(k){return{title:k.name,folder:k.isDir,lazy:k.isDir,key:k.rel+k.name,data:{url:k.url,path:k.rel+k.name,dir:k.rel}}})}function i(j){return new Promise(function(k){var l=a('#ci-dialog');0===l.length&&(l=a('<div/>').css('id','ci-dialog'),a('body').append(l)),l.html(j),l.dialog({modal:!0,buttons:{Cancel:function(){a(this).dialog('close')},Ok:function(){k(!0),a(this).dialog('close')}},close:function(){return k(!1)},width:400})})}return f.inherits(g,b,{initImpl:function(){var k=this;this.id=f.getNextUniqueId(),a.ui.fancytree.debugLevel=0,a(document).keydown(function(l){if((l.ctrlKey||l.metaKey)&&83==l.which)return l.preventDefault(),k.checkNode(),k.save(),!1})},_onClick:function(){this.createMenu()},createMenu:function(){var k=this;this.$_elToOpen||(this.$_elToOpen=a('<div/>').css('width',550)),this.setStyleOpen(this._open),this._open?(!this.$tree&&(this.$tree=this.$tree||a('<div/>').css('id',this.cssId('tree')).css('display','inline-block').css('margin-right',20),this.$_elToOpen.append('<div><p><label>Filter:</label><input name="search" placeholder="Filter..."><button id="btnResetSearch" disabled="disabled">\xD7</button><span id="matches"></span></p></div>'),this.$_elToOpen.append(this.$tree)),this.open(),this.initTree().then(function(){k.createButtons()})):this.close()},cssId:function(k){return'ci-navview-header-'+this.id+'-'+k},reloadTree:function(){this.$tree.fancytree('destroy'),this.initTree(!0)},reloadActiveNode:function(){this.reloadNode(this.$tree.fancytree('getActiveNode'))},reloadNode:function(k){if(k.isFolder()||(k=k.getParent()),k.isRoot())return void this.reloadTree();var l=k.isExpanded();k.load(!0).then(function(){l&&k.setExpanded(!0,{noAnimation:!0})})},getDir:function(k){return k.replace(new RegExp(/\/[^/]+$/),'/')},load:function(){},save:function(){var l,o,k=this;if(this.activeNode)l=this.getDir(this.activeNode.data.path),o=this.activeNode.title;else if(this.viewURL){l=this.getDir(this.viewURL),l=l.replace(/^\/views/,'.');var p=this.viewURL.lastIndexOf('/');o=-1<p?this.viewURL.slice(p+1):this.viewURL}else return;i('You are about to save the current view to: '+l+o+'<br/>This operation will erase the previous content of this file and cannot be undone.').then(function(q){if(q){var r=a.ajax({url:'/navview/save',data:{dir:l,name:o,content:c.getViewJSON('\t')},type:'POST',dataType:'json'});r.done(function(){k.log('success-log','Successfully saved view'),k.reloadActiveNode()}),r.fail(function(){k.log('error-log','Failed to save view')})}})},mkdir:function(){var k=this,l=this.activeNode.data.path;this.activeNode.isFolder()||(l=this.getDir(l));var o=this.getFormContent(this.$dirnameInput);if(l&&o){var p=a.ajax({url:'/navview/mkdir',type:'POST',data:{dir:l,name:o},dataType:'json'});p.done(function(){k.log('success-log','Successfully created directory'),k.reloadActiveNode()}),p.fail(function(){k.log('error-log','Failed create directory')})}},remove:function(k){var l=this;if(k.isFolder())return this.log('error-log','Failed remove file');var o=this.getDir(k.data.path),p=k.title;i('<p>You are about to remove the file: <br/>'+k.data.path+'</p>Do you really want to do this? You cannot undo this operation').then(function(q){if(q){var r=a.ajax({url:'/navview/file',type:'DELETE',data:{dir:o,name:p},dataType:'json'});r.done(function(){k.remove(),l.log('success-log','Successfully removed file')}),r.fail(function(){l.log('error-log','Failed remove file')})}})},removeDir:function(k){var l=this;return k.isFolder()?void i('<p>You are about to remove the directory: <br/>'+k.data.path+'</p>Do you really want to do this? You cannot undo this operation').then(function(o){if(o){var p=a.ajax({url:'/navview/dir',type:'DELETE',data:{dir:k.data.path},dataType:'json'});p.done(function(){k.remove(),l.log('success-log','Successfully removed directory')}),p.fail(function(){l.log('error-log','Failed remove directory')})}}):this.log('error-log','Failed remove directory')},rename:function(){var k=this,l=new RegExp(/(^.*)\/([^/]+$)/),o=l.exec(this.activeNode.data.path);if(3===!o.length)return void this.log('error-log','Invalid path...');var p=o[1],q=this.getFormContent('docName'),s=o[2],t=this.ajaxRename({dir:p,newDir:p,name:s,newName:q});t.done(function(){k.log('success-log','Successfully renamed file'),k.reloadActiveNode()}),t.fail(function(){k.log('error-log','Failed to rename file')})},ajaxRename:function(k){return a.ajax({url:'/navview/rename',type:'PUT',data:k,dataType:'json'})},inlineRename:function(k){var l=this,o={dir:k.data.dir,newDir:k.data.dir,newName:k.title,name:l.inlineOldTitle},p=this.ajaxRename(o);p.done(function(){k.setTitle(k.title),l.log('success-log','Successfully renamed file')}),p.fail(function(){k.setTitle(l.inlineOldTitle),l.log('error-log','Failed to rename file')})},newFile:function(){var k=this,l=k.activeNode.data.path;k.activeNode.isFolder()||(l=k.getDir(l));var o=a.ajax({url:'/navview/touch',type:'POST',data:{dir:l,name:k.getFormContent(this.$filenameInput)},dataType:'json'});o.done(function(){k.log('success-log','File successfully created'),k.reloadActiveNode()}),o.fail(function(){k.log('error-log','Failed to create new file')})},duplicate:function(){},checkNode:function(){this.activeNode||this.log('error-log','Error: you must select a node');var k=location.search.split('viewURL=')[1];k=decodeURIComponent(k),this.viewURL=k},log:function(k,l){if(this.$log){var o=this.$log.find('#'+this.cssId(k));0<o.length&&(this.currentLogTimeout&&clearTimeout(this.currentLogTimeout),this.$log.find('div').html(''),o.html(l)),this.currentLogTimeout=setTimeout(function(){o.html('')},5e3)}},loadRootTree:function(){return this.treeSchema?this.treeSchema:a.ajax({url:'/navview/list',dataType:'json'})},initTree:function(k){var l=this;return!k&&l.fancytreeOk?Promise.resolve():this.loadRootTree().then(function(o){var p=h(o);l.$tree.fancytree({toggleEffect:!1,extensions:['edit','filter'],filter:{mode:'dimm'},source:p,lazyLoad:function(s,t){t.result=a.ajax({url:'/navview/list?dir='+t.node.data.path,dataType:'json'}).then(h)},activate:function(s,t){l.activeNode=t.node,l.updateSaveViewText()},dblclick:function(s,t){c.switchView({view:{url:t.node.data.url}},!0)},keydown:function(s,t){switch(s.preventDefault(),s.which){case 8:t.node.isFolder()?l.removeDir(t.node):l.remove(t.node);}},edit:{triggerStart:['f2','shift+click','mac+enter'],beforeEdit:function(s,t){return!t.node.isFolder()&&void(l.inlineOldTitle=t.node.title)},edit:function(){},beforeClose:function(){},save:function(s,t){return t.node.setTitle(t.input.val()),a(t.node.span).addClass('pending'),l.inlineRename(t.node),!0},close:function(s,t){t.save&&a(t.node.span).addClass('pending')}}}),l.fancytreeOk=!0;var q=l.$tree.fancytree('getTree');l.$_elToOpen.find('input[name=search]').keyup(function(r){var s,t=a(this).val();return r&&r.which===a.ui.keyCode.ESCAPE||''===a.trim(t)?void a('button#btnResetSearch').click():void(s=q.filterNodes(t,!1),a('button#btnResetSearch').attr('disabled',!1),a('span#matches').text('('+s+' matches)'))}).focus(),a('button#btnResetSearch').click(function(){a('input[name=search]').val(''),a('span#matches').text(''),q.clearFilter()}).attr('disabled',!0)})},createButtons:function(){var k=this;if(!this._buttons){this.$log=a('<div/>').attr('id',this.cssId('log')).css('margin-bottom',10),this.$_elToOpen.append('<div/>').children(':gt(1)').css('display','inline-block').css('vertical-align','top').append(this.$log),this.$log.append(a('<div/>').attr('id',this.cssId('error-log')).css('color','red')),this.$log.append(a('<div/>').attr('id',this.cssId('success-log')).css('color','green')),this.$log.parent().append(new d('Refresh Tree',function(){k.reloadTree()},{color:'blue'}).render()),this.$log.parent().append('<br/><br/><br/><div>\n    <ul>\n        <li style="color:black;">Double-click a view to load it</li>\n        <li style="color: black;">Shift+click to rename a view</li>\n        <li style="color: black;">Press delete key to remove a view or a directory</li>\n    </ul>\n</div>');var l=a('<div>\n    <table>\n        <tr>\n            <td></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type="text"/></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type="text"/></td>\n            <td></td>\n        </tr>\n    </table>\n</div>');this.$_elToOpen.append(l);var o=l.find('input');this.$dirnameInput=a(o[0]),this.$filenameInput=a(o[1]);var p=l.find('td');this.$saveViewText=a(p[0]),a(p[1]).append(new d('Save view',function(){k.checkNode(),k.save()},{color:'red'}).render()),a(p[3]).append(new d('Mkdir',function(){k.checkNode(),k.mkdir()},{color:'blue'}).render()),a(p[5]).append(new d('New file',function(){k.checkNode(),k.newFile()},{color:'blue'}).render()),this._buttons=!0}},updateSaveViewText:function(){this.$saveViewText.html(this.activeNode.data.path)},getFormContent:function(k){return'string'==typeof k?a('#'+this.cssId(k)).val().trim():k instanceof jQuery?k.val().trim():void 0},setFormContent:function(k,l){a('#'+this.cssId(k)).val(l)}}),g});
