"use strict";function _asyncToGenerator(t){return function(){var o=t.apply(this,arguments);return new Promise(function(n,r){function d(s,l){try{var c=o[s](l),p=c.value}catch(u){return void r(u)}return c.done?void n(p):Promise.resolve(p).then(function(u){d("next",u)},function(u){d("throw",u)})}return d("next")})}}define(["jquery","lodash","superagent","src/header/components/default","src/util/util","src/util/ui","src/util/debug","src/util/roc-view","src/util/versioning","src/util/couchdbAttachments","src/util/uploadUi","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/ui/widgets/accordion","jquery-ui/ui/widgets/tooltip"],function(t,o,n,r,d,s,l,c,p,u,h){"use strict";function f(B,F){return B.folder===F.folder?B.title.localeCompare(F.title):B.folder?-1:1}function w(B,F,T,S){var L=B.get(T);L||(L=new Map,B.set(T,L));for(var H,D=0;D<S.length-1;D++)H="__folder__"+S[D],L.has(H)||L.set(H,new Map),L=L.get(H);var R=x(L,S[D]);L.set(R,F)}function x(B,F){for(;B.has(F);)F="__view__"+F;return F}function g(B){return B=B.trim(),!!(0<B.length)&&B}function y(B){return B=B.trim(),!!/^[a-zA-Z0-9$_-]+$/.test(B)&&B}function N(B){return B.replace("__folder__","").replace(/(__view__)+/,"")}var k=52428800,V={color:"blue",cursor:"pointer",textDecoration:"underline"},A=o.template("<table>\n    <tr>\n        <td style=\"vertical-align: top;\"><b>Document id</b></td>\n        <td><%= view.id %></td>\n    </tr>\n    <tr>\n        <td style=\"vertical-align: top;\"><b>Flavor</b></td>\n        <td><%= flavor %></td>\n    </tr>\n    <tr>\n        <td style=\"vertical-align: top;\"><b>Name</b></td>\n        <td><% print(flavors[flavors.length-1]) %></td>\n    </tr>\n    <tr>\n        <td style=\"vertical-align: top;\"><b>Location</b></td>\n        <td><li><% print(flavors.join('</li><li>')) %></li></td>\n    </tr>\n</table>");class C extends r{get flavor(){return this._flavor?this._flavor:this._flavor=window.localStorage.getItem("ci-visualizer-roc-views-flavor")||"default"}set flavor(B){this._flavor=B,window.localStorage.setItem("ci-visualizer-roc-views-flavor",B)}initImpl(){var B=this.options||{};if(!B.url||!B.database)throw new Error("roc-views: url and database options are mandatory");this.rocUrl=B.url.replace(/\\$/,""),this.rocDatabase=B.database,this.rocDbUrl=`${this.rocUrl}/db/${this.rocDatabase}`,this.rocReady=!1,this.rocAuthenticated=!1,this.rocUsername=null,this._flavor=null,this.activeNode=null,this.activeView=null,this.loadedNode=null,this.verifyRoc(),t(document).keydown((F)=>{(F.ctrlKey||F.metaKey)&&!F.altKey&&83===F.which&&(F.preventDefault(),this.saveCurrentView("loaded"))})}_onClick(){this.rocReady?(this.setStyleOpen(this._open),this._open?(this.createDom(),this.open()):this.close()):(s.showNotification("View database does not respond","error"),l.error("roc-views: unreachable database. Retrying now"),this.verifyRoc())}getRequest(B,F){var T=n.get(this.rocUrl+B).withCredentials();return F&&T.query(F),T}getRequestDB(B,F){return this.getRequest("/db/"+this.rocDatabase+B,F)}putRequestDB(B,F){var T=n.put(this.rocDbUrl+B).withCredentials();return T.send(F),T}postRequestDB(B,F){var T=n.post(this.rocDbUrl+B).withCredentials();return T.send(F),T}deleteRequestDB(B){return n.del(this.rocDbUrl+B).withCredentials()}verifyRoc(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T;return regeneratorRuntime.wrap(function(L){for(;;)switch(L.prev=L.next){case 0:return L.next=2,B.getRequest("/auth/session");case 2:if(T=L.sent,200===T.statusCode){L.next=6;break}return l.error("roc-views: unable to contact "+B.rocUrl),L.abrupt("return");case 6:if(T.body.ok){L.next=9;break}return l.error("roc-views: unexpected response",T.body),L.abrupt("return");case 9:B.rocReady=!0,T.body.authenticated&&(B.rocAuthenticated=!0,B.rocUsername=T.body.username,B.getMenuContent());case 11:case"end":return L.stop();}},F,B)}))()}createDom(){this.$_elToOpen||(this.$_elToOpen=t("<div>")),this.rocAuthenticated?this.openMenu("tree"):this.openMenu("login")}openMenu(B){switch(B){case this.currentMenu:return;case"tree":this.$_elToOpen.html(this.getMenuContent()),this.currentMenu="tree";break;case"login":this.$_elToOpen.html(this.getLoginContent()),this.currentMenu="login";break;default:l.error("roc-views: unexpected value for which: "+B);}}getLoginContent(){var B=t("<div>"),F=t("<a>",{text:"here",href:"#",click:()=>this.login()});return B.append("Click ").append(F).append(" to login"),B}login(){var B=encodeURIComponent(document.location.href);document.location.href=this.rocUrl+"/auth/login?continue="+B}logout(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){return regeneratorRuntime.wrap(function(S){for(;;)switch(S.prev=S.next){case 0:return S.next=2,B.getRequest("/auth/logout");case 2:B.rocAuthenticated=!1,B.rocUsername=null,B.openMenu("login");case 5:case"end":return S.stop();}},F,B)}))()}getMenuContent(){if(this.$menuContent)return this.$menuContent;var B=this.$menuContent=t("<div id=\"root\">").css("position","relative"),F=this.$hide=t("<div>").css({position:"absolute",width:"100%",height:"100%",zIndex:2,display:"flex",alignItems:"center",justifyContent:"center"}).hide(),T=t("<div>").css("zIndex",1),S=t("<div>"),L=t("<p>",{css:{display:"inline-block",width:"50%"}});L.append(t("<a>",{click:this.refresh.bind(this),css:V,text:"refresh"}));var D=t("<p>",{css:{display:"inline-block",textAlign:"right",width:"50%"}});D.append(this.rocUsername+" | ").append(t("<a>",{click:this.logout.bind(this),css:V,text:"logout"})),S.append(L).append(D);var H=t("<div>",{css:{marginTop:"20px",width:"710px"}}),R=t("<div>",{css:{verticalAlign:"top",display:"inline-block",width:"360px"}}),I=t("<div></div>",{text:"Search: "}),U="",z=t("<input type=\"text\" size=\"20\">").keyup(()=>{var ae=z.val();ae!==U&&(this.doSearch(ae),U=ae)});I.append(z);var M=t("<div>"),E=t("<div>",{css:{overflowY:"auto",maxHeight:"500px"}});this.$tree=E,R.append(I).append(M).append(E);var O=t("<div>",{css:{display:"inline-block",height:"100%",marginLeft:"10px",width:"340px"}}),q=this.$title=t("<div>",{css:{width:"100%",textAlign:"center",paddingBottom:"5px"}}),P=t("<div>",{css:{height:"80%",width:"100%"}});P.append("<h3>View information</h3>"),this.$infoBox=t("<div>").appendTo(P),P.append("<h3>Revisions</h3>"),this.$revBox=t("<div>",{css:{maxHeight:"300px"}}).appendTo(P),P.append("<h3>Attachments</h3>"),this.$attachmentsBox=t("<div>").appendTo(P);var K=t("<button>Upload attachments</button>").button().click(()=>this.uploadFiles());this.$attachmentsBox.html(K),P.append("<h3>Permissions</h3>"),this.$permissionsBox=t("<div>").appendTo(P),P.append("<h3>Metadata</h3>"),this.$metaBox=t("<div>").appendTo(P);var Y=this.$publicCheckbox=t("<input type=\"checkbox\" />").click((ae)=>{ae.preventDefault(),this.togglePublic()}),G=t("<div>").append(Y).append("Public"),J=this.$ownersList=t("<div>").css({marginTop:"5px",marginBottom:"5px"}),W=t("<button>Add owner</button>").click(()=>this.addOwner()),X=t("<div>").append(J).append(W),Z=this.$permissionsContainer=t("<div>");this.$permissionsBox.html(Z),Z.append(G).append(X),P.accordion({heightStyle:"content"});var Q=t("<div>",{css:{paddingTop:"20px",height:"20%"}}),ee=this.$closeButton=t("<button>Close view</button>").button({disabled:!0}).click(()=>this.closeLoadedView()),te=this.$saveButton=t("<button>Save</button>").button({disabled:!0}).click(()=>this.saveCurrentView("active")),oe=this.$saveAsButton=t("<button>Save as</button>").button({disabled:!0}).click(()=>this.saveAs()),ie=this.$saveAsText=t("<input type=\"text\" size=\"15\" />").css("display","none");return Q.append(ee).append(te).append("<br>").append(oe).append(ie),O.append(q).append(P).append(Q),H.append(R).append(O),T.append(S).append(H),B.append(F).append(T),this.refresh(),B}getViews(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T;return regeneratorRuntime.wrap(function(L){for(;;)switch(L.prev=L.next){case 0:return L.next=2,B.getRequestDB("/entry/_all",{right:"write"});case 2:return T=L.sent,L.abrupt("return",T.body.filter(function(D){return!0!==D.$deleted}));case 4:case"end":return L.stop();}},F,B)}))()}refresh(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T,S;return regeneratorRuntime.wrap(function(D){for(;;)switch(D.prev=D.next){case 0:return B.populateInfo(),B.tree&&(B.$tree.fancytree("destroy"),B.tree=null),B.activeNode=null,B.setActiveView(null),B.setLoadedNode(null),D.next=7,B.getViews();case 7:T=D.sent,S=B.getTree(T),B.$tree.fancytree({source:S,toggleEffect:!1,debugLevel:0,extensions:["dnd","filter"],dnd:{autoExpandMS:300,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(R){return!B.inSearch&&!R.folder},dragEnter:function(R,I){var U=I.otherNode;return R.folder&&R===U.parent?!1:!!R.folder},dragDrop:function(R,I){var U=I.otherNode;B.showHide(!0),U.data.view.moveTo(R).then(function(z){B.showHide(!1),z?U.moveTo(R):s.showNotification("View could not be moved","error")})}},filter:{mode:"hide",fuzzy:!0},activate:function(R,I){return B.onActivate(R,I)},dblclick:function(R,I){return B.onDblclick(R,I)}}),B.$tree.on("mouseenter mouseleave","span.fancytree-title",function(H){var R=t.ui.fancytree.getNode(H);"mouseenter"!==H.type||R.folder?B.populateInfo(B.activeView):B.populateInfo(R)}),B.tree=B.$tree.fancytree("getTree"),B.renderFlavor(),B.$tree.contextmenu({delegate:"span.fancytree-title",preventContextMenuForPopup:!0,show:!1,menu:[],beforeOpen:function(R,I){if(B.inSearch)return!1;var U=t.ui.fancytree.getNode(I.target);if(U.folder){var z=U.data.path,M=[{title:"Create folder",cmd:"createFolder",uiIcon:"ui-icon-folder-collapsed"}];if(1===z.length){M.push({title:"New flavor...",cmd:"newFlavor",uiIcon:"ui-icon-document-b"}),M.push({title:"----"});for(var E=B.flavors,O=0;O<E.length;O++)M.push({title:E[O],cmd:"switchFlavor",uiIcon:E[O]===B.flavor?"ui-icon-check":void 0})}B.$tree.contextmenu("replaceMenu",M)}else{for(var Y,q=B.flavors,P=[],K=U.data.view.flavors,O=0;O<q.length;O++)Y=!!K[q[O]],P.push({title:q[O],cmd:"toggleFlavor",uiIcon:Y?"ui-icon-check":void 0});B.$tree.contextmenu("replaceMenu",[{title:"Rename",cmd:"renameView",uiIcon:"ui-icon-pencil"},{title:"Delete",cmd:"deleteView",uiIcon:"ui-icon-trash"},{title:"Flavors",children:P}])}U.setActive()},select:function(R,I){var z,U=t.ui.fancytree.getNode(I.target);switch(I.cmd){case"createFolder":B.createFolder(U);break;case"deleteView":B.deleteView(U);break;case"renameView":B.renameView(U);break;case"toggleFlavor":z=I.item.text(),B.toggleFlavor(U,z);break;case"switchFlavor":z=I.item.text(),B.switchToFlavor(z);break;case"newFlavor":B.newFlavor();break;default:l.error(`unknown action: ${I.cmd}`);}},createMenu(H){t(H.target).css("z-index",1e4)}}),B.selectLoadedNode();case 15:case"end":return D.stop();}},F,B)}))()}selectLoadedNode(){var B=p.lastLoaded.view.url,F=/\/([^/]+)\/view\.json/,T=F.exec(B);if(T){var S=(R)=>{R.getParent().setExpanded(!0),R.setActive(!0),this.setLoadedNode(R),this.setActiveView(R)},L=T[1],D=!1,H;this.tree.visit((R)=>{if(R.data.view&&R.data.view.id===L){if(R.data.flavor===this.flavor)return D=!0,S(R),!1;H||(H=R)}}),!D&&H&&(this.switchToFlavor(H.data.flavor),S(H))}}newFlavor(){var B=t("<div>Name of the new flavor: </div>"),F=t("<input type=\"text\" />").appendTo(B).on("keypress",(L)=>{13===L.keyCode&&T()}),T=()=>{var L=y(F.val());return L?void(-1===this.flavors.indexOf(L)&&(this.tree.rootNode.addNode({folder:!0,title:L,path:[L]}),this.flavors.push(L),this.flavors.sort()),this.switchToFlavor(L),S.dialog("destroy")):s.showNotification("Invalid name","error")},S=s.dialog(B,{buttons:{Create:T}})}createFolder(B){var F=t("<div>Name of the directory: </div>"),T=t("<input type=\"text\" />").appendTo(F).on("keypress",(D)=>{13===D.keyCode&&S()}),S=()=>{var D=g(T.val());if(!D)return s.showNotification("Invalid name","error");var H=B.getChildren();if(H)for(var R=0;R<H.length;R++)if(H[R].title===D&&H[R].folder)return s.showNotification(`Folder ${D} already exists`,"error");B.setExpanded(!0);var I=B.addNode({folder:!0,title:D,path:B.data.path.concat(D)});B.sortChildren(f),I.setActive(),L.dialog("destroy"),this.renderFlavor()},L=s.dialog(F,{buttons:{Save:S}})}deleteView(B){var F=this;return _asyncToGenerator(regeneratorRuntime.mark(function T(){var S;return regeneratorRuntime.wrap(function(D){for(;;)switch(D.prev=D.next){case 0:return D.next=2,s.confirm(`This will delete the view named "${B.title}" and all related data.<br>Are you sure?`,"Yes, delete it!","Maybe not...");case 2:if(!D.sent){D.next=9;break}return F.showHide(!0),D.next=6,B.data.view.remove();case 6:S=D.sent,F.showHide(!1),S?(s.showNotification("View deleted","success"),B.remove(),B===F.loadedNode&&(p.switchView({view:{},data:{}},!0,{doNotLoad:!0}),F.setLoadedNode(null),F.setActiveView(null))):s.showNotification("Error while deleting view","error");case 9:case"end":return D.stop();}},T,F)}))()}renameView(B){var F=t(`<div>Renaming view "${B.title}"<br>New name: </div>`),T=t(`<input type="text" value="${B.data.view.getName(B.data.flavor)}"/>`).appendTo(F).on("keypress",(D)=>{13===D.keyCode&&S()}).select(),S=()=>{var D=T.val().trim();return 0===D.length?s.showNotification("Name cannot be empty","error"):(this.showHide(!0),B.data.view.rename(B.data.flavor,D).then((H)=>{this.showHide(!1),H?(s.showNotification("View was renamed","success"),B.setTitle(D),this.renderActiveView()):s.showNotification("Error while renaming view","error"),L.dialog("destroy")}))},L=s.dialog(F,{buttons:{Rename:S}})}toggleFlavor(B,F){var T=this;return _asyncToGenerator(regeneratorRuntime.mark(function S(){var L,D,H,R,I,U,z,M,E,O;return regeneratorRuntime.wrap(function(P){for(;;)switch(P.prev=P.next){case 0:return L=B.data.view,T.showHide(!0),P.next=4,L.toggleFlavor(F,T.flavor);case 4:if(D=P.sent,T.showHide(!1),D){P.next=10;break}s.showNotification("Error while toggling flavor","error"),P.next=59;break;case 10:if("err-one"!==D.state){P.next=14;break}s.showNotification("Cannot remove the last flavor","error"),P.next=59;break;case 14:if("removed"!==D.state){P.next=25;break}if(H=void 0,T.tree.rootNode.visit(function(K){if(K.data.view===L&&K.data.flavor===F)return H=K,!1}),!H){P.next=21;break}H.remove(),P.next=22;break;case 21:throw new Error("Node not found");case 22:s.showNotification(`Flavor ${F} removed`,"success"),P.next=59;break;case 25:if("added"!==D.state){P.next=58;break}R=T.tree.rootNode.getChildren(),I=!0,U=!1,z=void 0,P.prev=30,M=R[Symbol.iterator]();case 32:if(I=(E=M.next()).done){P.next=40;break}if(O=E.value,O.title!==F){P.next=37;break}return T.addNodeAndSelect(O,{title:D.name,folder:!1,view:L,flavor:F}),P.abrupt("break",40);case 37:I=!0,P.next=32;break;case 40:P.next=46;break;case 42:P.prev=42,P.t0=P["catch"](30),U=!0,z=P.t0;case 46:P.prev=46,P.prev=47,!I&&M.return&&M.return();case 49:if(P.prev=49,!U){P.next=52;break}throw z;case 52:return P.finish(49);case 53:return P.finish(46);case 54:T.switchToFlavor(F),s.showNotification(`Flavor ${F} added`,"success"),P.next=59;break;case 58:throw new Error("unexpected result: "+D);case 59:T.renderActiveView();case 60:case"end":return P.stop();}},S,T,[[30,42,46,54],[47,,49,53]])}))()}doSearch(B){""===B?(this.inSearch=!1,this.tree.clearFilter(),this.renderFlavor()):(this.inSearch=!0,this.tree.filterNodes(B,{autoExpand:!0,leavesOnly:!0}))}switchToFlavor(B){this.flavor!==B&&(this.flavor=B,this.renderFlavor(),this.loadedNode&&!this.loadedNode.data.view.hasFlavor(B)&&(this.setLoadedNode(null),this.setActiveView(null)))}renderFlavor(){var B=!1;this.tree.filterBranches((F)=>{return F.folder&&F.title===this.flavor&&1===F.data.path.length?(B=!0,F.setExpanded(!0),!0):(F.setExpanded(!1),!1)}),B||(this.tree.rootNode.addNode({folder:!0,title:this.flavor,path:[this.flavor]}),this.flavors.push(this.flavor),this.flavors.sort(),this.renderFlavor())}onActivate(B,F){this.activeNode=F.node,F.node.folder?(this.setActiveView(this.loadedNode),this.$saveAsButton.button("enable"),this.$saveAsText.show()):(this.setActiveView(F.node),this.$saveAsButton.button("disable"),this.$saveAsText.hide())}populateInfo(B){if(!B)return this.$title.html("&nbsp;"),this.$infoBox.empty(),this.$revBox.empty(),this.$permissionsContainer.hide(),void this.$metaBox.empty();var F=B.data.view;this.$title.text(F.title),this.$infoBox.html(t("<p>").append(`Name: <b>${o.escape(B.title)}</b><br>
                Folder: ${F.getPath(B.data.flavor)}<br>
                Visualizer version: ${F.version}<br><br>
                Size: ${d.formatSize(F.size)}<br>
                Id: ${F.id}<br>
                Last revision: ${F.revid}<br><br>
                Created on: ${F.creationDate.toLocaleString()}<br>
                Last modified: ${F.modificationDate.toLocaleString()}<br>
                Owner: ${F.owner}`)),this.$metaBox.html(t("<p>").append(`
                    <table>
                    <tr><td>Keywords:</td><td><input type="text" value="${F.keywords?F.keywords.join(", "):""}"/></td></tr>
                    <tr><td>Icon:</td><td><input type="text" value="${F.icon||""}" /></td></tr>
                    <tr><td>Short name:</td><td><input type="text" value="${F.name||""}" /></td></tr>
                    <tr><td>Category:</td><td><input type="text" value="${F.category||""}" /></td></tr>
                    </table>
                `)),this.loadedNode&&this.loadedNode!==this.activeNode&&(this.$infoBox.append("<br>"),this.$infoBox.append(t("<p>").append(t("<a>",{click:this.selectLoadedNode.bind(this),css:V,text:"Select current view"})))),this.reloadRevisions(B),this.$permissionsContainer.show(),this.$publicCheckbox.prop("checked",F.public),this.$ownersList.html("Owners: "+F.owners.join(", "))}reloadRevisions(B,F){var T=this;return _asyncToGenerator(regeneratorRuntime.mark(function S(){var L,D;return regeneratorRuntime.wrap(function(R){for(;;)switch(R.prev=R.next){case 0:return L=B.data.view,T.$revBox.html("loading..."),R.next=4,L.getRevisions(F);case 4:D=R.sent,T.$revBox.empty(),T.$revBox.append(t("<p>").html(t("<a>",{click:T.reloadRevisions.bind(T,B,!0),css:V,text:"refresh"}))),T.$revBox.append("<br>"),D.forEach(function(I){var U=t("<a>",{click:T.loadRevision.bind(T,B,I),css:V,class:"roc-revision-link",text:I,title:""});U.tooltip({content:T.updateRevInfo.bind(T,B,I)});var z=t("<p>").html(U);T.$revBox.append(z)});case 9:case"end":return R.stop();}},S,T)}))()}loadRevision(B,F){var T=B.data.view;T.setRevision(F),this.loadNode(B)}updateRevInfo(B,F,T){var S=this;return _asyncToGenerator(regeneratorRuntime.mark(function L(){var D,H;return regeneratorRuntime.wrap(function(I){for(;;)switch(I.prev=I.next){case 0:return D=B.data.view,I.next=3,D.getRevisionData(F);case 3:H=I.sent,T(new Date(H.$modificationDate).toLocaleString());case 5:case"end":return I.stop();}},L,S)}))()}saveAs(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T,S,L,D,H,R,I,U,z,M,E,O,q,P;return regeneratorRuntime.wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(T=B.activeNode,T.folder){Y.next=3;break}return Y.abrupt("return");case 3:S=B.$saveAsText.val().split("/"),L=0;case 5:if(!(L<S.length)){Y.next=13;break}if(D=g(S[L]),D){Y.next=9;break}return Y.abrupt("return",s.showNotification("Invalid name","error"));case 9:S[L]=D;case 10:L++,Y.next=5;break;case 13:H=0;case 14:if(!(H<S.length-1)){Y.next=33;break}if(R=S[H],I=T.getChildren(),!I){Y.next=26;break}U=0;case 19:if(!(U<I.length)){Y.next=26;break}if(!(I[U].title===R&&I[U].folder)){Y.next=23;break}return T=I[U],Y.abrupt("continue",30);case 23:U++,Y.next=19;break;case 26:T.setExpanded(!0),z=T.addNode({folder:!0,title:R,path:T.data.path.concat(R)}),T.sortChildren(f),T=z;case 30:H++,Y.next=14;break;case 33:return M=S[S.length-1],E=B.getCurrentView(),O=B.flavor,q={$kind:"view",$content:{version:E.version,title:E.title,flavors:{[O]:T.data.path.slice(1).concat(M)}},_attachments:{"view.json":E.attachment}},P=new c(q,B),B.showHide(!0),Y.prev=39,Y.next=42,P.save();case 42:Y.next=49;break;case 44:return Y.prev=44,Y.t0=Y["catch"](39),B.showHide(!1),s.showNotification("View could not be saved","error"),Y.abrupt("return");case 49:B.showHide(!1),s.showNotification("View saved","success"),B.addNodeAndSelect(T,{title:M,folder:!1,view:P,flavor:O}),p.switchView(P.getViewSwitcher(),!0,{doNotLoad:!0});case 53:case"end":return Y.stop();}},F,B,[[39,44]])}))()}closeLoadedView(){this.loadedNode&&(p.switchView({view:{},data:{}},!0),this.setLoadedNode(null))}saveCurrentView(B){var F;if(F="active"===B?this.activeView:this.loadedNode,F)var T=s.dialog(A({view:F.data.view,flavor:F.data.flavor,flavors:F.data.view.flavors[F.data.flavor]}),{width:"400px",buttons:{Save:()=>{T.dialog("close"),this.showHide(!0),F.data.view.saveView(this.getCurrentView()).then((S)=>{this.showHide(!1),S?(s.showNotification("View saved","success"),this.renderActiveView()):s.showNotification("View could not be saved","error")})}}});else s.showNotification("No view loaded in view manager","error")}onDblclick(B,F){var T=F.node;if(!T.folder){var S=T.data.flavor;this.switchToFlavor(S),this.inSearch&&this.doSearch(""),T.setActive(!0),T.data.view.setRevision(null),this.loadNode(T)}}loadNode(B){this.setLoadedNode(B);var F=B.data.view;p.switchView(F.getViewSwitcher(),!0,{withCredentials:!0})}getTree(B){for(var L,F=new Map,T=new Set,S=0;S<B.length;S++)for(var D in L=new c(B[S],this),L.content.flavors)T.add(D),w(F,L,D,L.content.flavors[D]);this.flavors=Array.from(T).sort();var U,H=[],R=!0,I=!1;try{for(var M,z=F[Symbol.iterator]();!(R=(M=z.next()).done);R=!0){var E=M.value,O=N(E[0]);this.buildElement(H,O,E[1],[O],!0,O)}}catch(q){I=!0,U=q}finally{try{!R&&z.return&&z.return()}finally{if(I)throw U}}return H.sort(f),H}buildFolder(B,F,T,S,L){var D=!0,H=!1,R;try{for(var U,I=F[Symbol.iterator]();!(D=(U=I.next()).done);D=!0){var z=U.value,M=N(z[0]);this.buildElement(B,M,z[1],T.concat(M),S,L)}}catch(E){H=!0,R=E}finally{try{!D&&I.return&&I.return()}finally{if(H)throw R}}B.sort(f)}buildElement(B,F,T,S,L,D){if(T instanceof Map){var H={title:F,folder:!0,children:[],path:S};L&&F===this.flavor&&(H.expanded=!0),this.buildFolder(H.children,T,S,!1,D),B.push(H)}else B.push({title:F,folder:!1,view:T,flavor:D})}addNodeAndSelect(B,F){var T=B.addNode(F);return B.sortChildren(f),B.setExpanded(!0),T.setActive(!0),this.renderFlavor(),this.setLoadedNode(T),this.setActiveView(T),T}setLoadedNode(B){this.loadedNode=B,B?this.$closeButton.button("enable"):this.$closeButton.button("disable")}setActiveView(B){this.activeView=B,B?this.$saveButton.button("enable"):this.$saveButton.button("disable"),this.renderActiveView()}renderActiveView(){this.populateInfo(this.activeView)}showHide(B){clearTimeout(this._showTimeout),B?(this.$hide.show(),this._showTimeout=setTimeout(()=>{this.$hide.html(d.getLoadingAnimation())},1e3)):(this.$hide.empty(),this.$hide.hide())}uploadFiles(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T,S,L,D,H,R,I,U,z,M,E,O,q,P;return regeneratorRuntime.wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(B.activeView){Y.next=2;break}return Y.abrupt("return");case 2:return T=`${B.rocDbUrl}/entry/${B.activeView.data.view.id}`,S=new u(T),Y.next=6,S.fetchList();case 6:return L=Y.sent,Y.next=9,h.uploadDialog(L,{mode:"couch",docUrl:T});case 9:if(D=Y.sent,D&&0!==D.length){Y.next=12;break}return Y.abrupt("return");case 12:for(B.showHide(!0),H=o.partition(D,function(G){return G.toDelete}),R=H[0],H=o.partition(H[1],function(G){return G.size<k}),I=H[1],U=H[0],U.sort(function(G,J){return G.size<J.size?1:G.size===J.size?0:-1}),z=[],M=[],E=0,O=0;O<U.length;O++)E+=U[O].size,E<k?M.push(U[O]):(z.push(M),M=[U[O]],E=U[O].size);return M.length&&z.push(M),Y.prev=24,Y.next=27,S.remove(o.map(R,"name"));case 27:q=0;case 28:if(!(q<I.length)){Y.next=34;break}return Y.next=31,S.upload(I[q]);case 31:q++,Y.next=28;break;case 34:P=0;case 35:if(!(P<z.length)){Y.next=41;break}return Y.next=38,S.inlineUploads(z[P]);case 38:P++,Y.next=35;break;case 41:B.showHide(!1),s.showNotification("Files uploaded successfully","success"),Y.next=51;break;case 45:return Y.prev=45,Y.t0=Y["catch"](24),B.showHide(!1),s.showNotification("Files upload failed (at least partially)","error"),l.error(Y.t0.message,Y.t0.stack),Y.abrupt("return");case 51:return Y.next=53,B.reloadCurrent();case 53:case"end":return Y.stop();}},F,B,[[24,45]])}))()}reloadCurrent(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){return regeneratorRuntime.wrap(function(S){for(;;)switch(S.prev=S.next){case 0:if(B.loadedNode){S.next=2;break}return S.abrupt("return");case 2:return S.next=4,B.loadedNode.data.view.reload();case 4:B.renderActiveView();case 5:case"end":return S.stop();}},F,B)}))()}togglePublic(){var B=this;return _asyncToGenerator(regeneratorRuntime.mark(function F(){var T;return regeneratorRuntime.wrap(function(L){for(;;)switch(L.prev=L.next){case 0:if(B.activeView){L.next=2;break}return L.abrupt("return");case 2:return B.showHide(!0),L.next=5,B.activeView.data.view.togglePublic();case 5:T=L.sent,B.showHide(!1),B.renderActiveView(),T||s.showNotification("Could not change permissions","error");case 9:case"end":return L.stop();}},F,B)}))()}addOwner(){if(this.activeView)var B=t("<div>User email address: </div>"),F=t("<input type=\"text\" />").appendTo(B).on("keypress",(L)=>{13===L.keyCode&&T()}),T=()=>{var L=F.val();return d.isEmail(L)?void(this.showHide(!0),this.activeView.data.view.addGroup(L).then((D)=>{D||s.showNotification("Could not add owner","error"),this.renderActiveView(),this.showHide(!1)}),S.dialog("destroy")):s.showNotification("Invalid email","error")},S=s.dialog(B,{buttons:{Add:T}})}getMeta(){var B={},F=this.$metaBox.find("input");return F[0]&&(B.keywords=F[0].value.split(",").map((T)=>T.trim()).filter((T)=>T)),F[1]&&(B.icon=F[1].value||void 0),F[2]&&(B.name=F[2].value||void 0),F[3]&&(B.category=F[3].value||void 0),B}getCurrentView(){var B=p.getView(),F=p.getViewJSON(),T=(B.configuration?B.configuration.title:"")||"";return Object.assign(this.getMeta(),{version:B.version,title:T,attachment:{content_type:"application/json",data:btoa(unescape(encodeURIComponent(F)))}})}}return C});
