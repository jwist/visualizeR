"use strict";function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(d,f){function g(h,j){try{var k=b[h](j),m=k.value}catch(n){return void f(n)}return k.done?void d(m):Promise.resolve(m).then(function(n){g("next",n)},function(n){g("throw",n)})}return g("next")})}}define(["src/util/versioning","superagent","src/util/util","fetch"],function(a,b,d,f){function g(o){for(var q=void 0,s=Math.min(100,o.length),u=0;u<s;u++)if(";"===o[u]){q=u+1;break}var v=o.slice(q,q+7);if(q&&"base64,"===v)return q+=7,o.slice(q);throw new Error("Could not parse dataurl")}function h(o,q){var s=[],u=0;for(var v in q)s.push(q[v]),s[u].name=v,s[u].filename=v,s[u].url=encodeURI(o.docUrl+"/"+v),u++;return o.lastAttachmentsResult=s,s}function j(o){return o.name||o.filename}var k=(()=>{var o=_asyncToGenerator(regeneratorRuntime.mark(function q(s,u){var v=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},w,x;return regeneratorRuntime.wrap(function(z){for(;;)switch(z.prev=z.next){case 0:return z.next=2,s.list();case 2:if(Array.isArray(u)){z.next=4;break}throw new TypeError("Argument should be an array");case 4:if(0!==u.length){z.next=6;break}return z.abrupt("return",s.list());case 6:for(w=0;w<u.length;w++)delete s.lastDoc._attachments[u[w]];return z.next=9,b.put(s.docUrl).withCredentials().set("Content-Type","application/json").set("Accept","application/json").send(s.lastDoc);case 9:if(x=z.sent,x&&x.body&&x.body.rev&&(s.lastDoc._rev=x.body.rev),!v.noRefresh){z.next=15;break}return z.abrupt("return",h(s,s.lastDoc._attachments));case 15:return z.abrupt("return",s.refresh());case 16:case"end":return z.stop();}},q,this)}));return function(){return o.apply(this,arguments)}})();var m=/^data:([a-z]+\/[a-z]+)?;base64,/;return class{constructor(o){if(0===arguments.length){var q=a.lastLoaded.view.url;if(!q)throw new Error("couchdb attachments initialization failed: No view url");this.docUrl=q.replace(/\/[^/]+$/,"")}else this.docUrl=o}setDoc(o){this.lastDoc=o}list(o){var q=this;return _asyncToGenerator(regeneratorRuntime.mark(function s(){var u;return regeneratorRuntime.wrap(function(w){for(;;)switch(w.prev=w.next){case 0:if(u=q.lastDoc&&q.lastDoc._attachments,q.lastDoc||!o){w.next=3;break}throw new Error("Unreachable");case 3:if(u||o){w.next=9;break}return w.next=6,q.refresh();case 6:return w.abrupt("return",q.list(!0));case 9:u||(q.lastDoc._attachments={});case 10:return w.abrupt("return",q.attachmentsAsArray(q,q.lastDoc._attachments));case 11:case"end":return w.stop();}},s,q)}))()}inlineUploads(o){var q=arguments,s=this;return _asyncToGenerator(regeneratorRuntime.mark(function u(){var v=1<q.length&&q[1]!==void 0?q[1]:{},w,x,y,z,A;return regeneratorRuntime.wrap(function(C){for(;;)switch(C.prev=C.next){case 0:return C.next=2,s.list();case 2:if(o){C.next=6;break}return C.abrupt("return",h(s,s.lastAttachmentsResult));case 6:if(Array.isArray(o)){C.next=8;break}throw new TypeError("options must be an array");case 8:for(w=[],x=function(E){var F=j(o[E]),G=o[E],H=G.data||G.file||G.content;if("string"==typeof H){if("base64"===G.encoding)s.lastDoc._attachments[F]={content_type:G.contentType,data:H};else{var I=m.exec(H.slice(0,64));s.lastDoc._attachments[F]=I?{content_type:G.contentType||I[1],data:H.slice(I[0].length)}:{content_type:G.contentType,data:btoa(unescape(encodeURIComponent(H)))}}}else if(H instanceof Blob){!G.contentType&&H.type&&(G.contentType=H.type);var J=new Promise(function(K,L){var M=new FileReader;M.onload=function(N){return K({item:G,base64data:g(N.target.result)})},M.onerror=function(){return L(new Error("Error while reading file"))},M.readAsDataURL(H)});w.push(J)}else throw new Error("Item must have a valid data or file property")},y=0;y<o.length;y++)x(y);return C.next=13,Promise.all(w);case 13:for(z=C.sent,y=0;y<z.length;y++)A=z[y],s.lastDoc._attachments[j(A.item)]={content_type:A.item.contentType,data:A.base64data};return C.next=17,b.put(s.docUrl).withCredentials().set("Content-Type","application/json").set("Accept","application/json").send(s.lastDoc);case 17:if(!v.noRefresh){C.next=21;break}return C.abrupt("return",h(s,s.lastDoc._attachments));case 21:return C.abrupt("return",s.refresh());case 22:case"end":return C.stop();}},u,s)}))()}upload(o){var q=arguments,s=this;return _asyncToGenerator(regeneratorRuntime.mark(function u(){var v=1<q.length&&q[1]!==void 0?q[1]:{},w,x,y,z;return regeneratorRuntime.wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(o){B.next=2;break}throw new Error("Invalid arguments");case 2:return w=o.data||o.file||o.content,B.next=5,s.list();case 5:if(x=o.contentType,x||!(w instanceof Blob)){B.next=10;break}x=w.type,B.next=16;break;case 10:if("string"!=typeof w){B.next=14;break}"base64"===o.encoding?w=o.data:(y=m.exec(w.slice(0,64)),y?(w=d.b64toBlob(w.slice(y[0].length),y[1]),x=y[1]):w=new Blob([w],{content_type:o.contentType})),B.next=16;break;case 14:if(w instanceof Blob){B.next=16;break}throw new Error("Data must be Blob or base64 dataUrl");case 16:if(x){B.next=18;break}throw new Error("Content-Type unresolved. Cannot upload document without content-type");case 18:return B.next=20,b.put(s.docUrl+"/"+j(o)).withCredentials().query({rev:s.lastDoc._rev}).set("Content-Type",x).set("Accept","application/json").send(w);case 20:if(z=B.sent,z&&z.body&&z.body.rev&&(s.lastDoc._rev=z.body.rev),!v.noRefresh){B.next=26;break}return B.abrupt("return",h(s,s.lastDoc._attachments));case 26:return B.abrupt("return",s.refresh());case 27:case"end":return B.stop();}},u,s)}))()}get(o,q){var s=this;return _asyncToGenerator(regeneratorRuntime.mark(function u(){var v,w,x,y,z;return regeneratorRuntime.wrap(function(B){for(;;)switch(B.prev=B.next){case 0:return q=q||{},B.next=3,s.list();case 3:if(v=s.lastDoc._attachments[o],v){B.next=6;break}throw new Error("The attachment "+o+" does not exist");case 6:if(w=`${s.docUrl}/${o}`,q.responseType){B.next=22;break}return x=b.get(w).withCredentials(),v&&x.set("Accept",s.lastDoc._attachments[o].content_type),B.next=12,x.query({rev:s.lastDoc._rev});case 12:if(y=B.sent,!q.raw){B.next=17;break}return B.abrupt("return",y.text);case 17:if(!q.responseType){B.next=19;break}return B.abrupt("return",y.xhr.response);case 19:return B.abrupt("return",y.body||y.text);case 22:return B.next=24,f(w,{credentials:"include"});case 24:z=B.sent,B.t0=q.responseType,B.next="arraybuffer"===B.t0?28:"blob"===B.t0?29:"json"===B.t0?30:"text"===B.t0?31:32;break;case 28:return B.abrupt("return",z.arrayBuffer());case 29:return B.abrupt("return",z.blob());case 30:return B.abrupt("return",z.json());case 31:return B.abrupt("return",z.text());case 32:case"end":return B.stop();}},u,s)}))()}remove(o){var q=arguments,s=this;return _asyncToGenerator(regeneratorRuntime.mark(function u(){var v=1<q.length&&q[1]!==void 0?q[1]:{},w;return regeneratorRuntime.wrap(function(y){for(;;)switch(y.prev=y.next){case 0:if(!Array.isArray(o)){y.next=2;break}return y.abrupt("return",k(s,o,v));case 2:return y.next=4,s.list();case 4:if(s.lastDoc._attachments[o]){y.next=6;break}throw new Error("Cannot remove attachment, attachment does not exist.");case 6:return y.next=8,b.del(s.docUrl+"/"+o).withCredentials().query({rev:s.lastDoc._rev}).set("Accept","application/json");case 8:if(w=y.sent,!(w&&w.body&&w.body.rev)){y.next=15;break}return s.lastDoc._rev=w.body.rev,delete s.lastDoc._attachments[o],y.abrupt("return",h(s,s.lastDoc._attachments));case 15:throw new Error("Unexpected error when removing attachments");case 16:case"end":return y.stop();}},u,s)}))()}refresh(){var o=this;return _asyncToGenerator(regeneratorRuntime.mark(function q(){var s;return regeneratorRuntime.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return v.next=2,b.get(o.docUrl).withCredentials().set("Accept","application/json");case 2:return s=v.sent,o.lastDoc=s.body,v.abrupt("return",h(o,s.body._attachments));case 5:case"end":return v.stop();}},q,o)}))()}fetchList(){return this.refresh()}attachmentsAsArray(){var o=[],q=0;for(var s in this.lastDoc._attachments)o.push(this.lastDoc._attachments[s]),o[q].name=s,o[q].url=encodeURI(this.docUrl+"/"+s),q++;return this.lastAttachmentsResult=o,o}uploads1(o){var q=arguments,s=this;return _asyncToGenerator(regeneratorRuntime.mark(function u(){var v=1<q.length&&q[1]!==void 0?q[1]:{},w,x,y,z;return regeneratorRuntime.wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(Array.isArray(o)){B.next=2;break}throw new Error("uploads expects an array as parameter");case 2:for(w=b.post(s.docUrl).withCredentials(),x=0;x<o.length;x++)y=o[x],w.attach("_attachments",y,j(y));return w.field("_rev",s.lastDoc._rev),B.next=7,w;case 7:if(z=B.sent,201===z.status){B.next=10;break}throw new Error("Error uploading attachments, couchdb returned status code "+z.status);case 10:if(!v.noRefresh){B.next=14;break}return B.abrupt("return",h(s,s.lastDoc._attachments));case 14:return B.abrupt("return",s.refresh());case 15:case"end":return B.stop();}},u,s)}))()}}});
