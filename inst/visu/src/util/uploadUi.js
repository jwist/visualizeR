'use strict';define(['src/util/util','src/util/debug','src/util/ui','lodash','jquery','slickgrid','mime-types'],function(a,b,c,f,g,h,j){'use strict';function k(t,u){for(var y,w=Array(t.length),x=0;x<t.length;x++)y=t[x],w[x]={name:y.name,contentType:y.content_type,size:y.length,toDelete:!1},u.docUrl&&(w[x].downloadUrl=u.docUrl+'/'+y.name);return w}function m(t,u){function w(x,y){return x<y?-1:y<x?1:0}t.onSort.subscribe(function(x,y){u.sort(w,y.sortAsc,function(z){return z[y.sortCol.field]}),t.invalidateAllRows(),t.render()})}function n(t,u,w,x,y){var z=y.name.replace(/^.*\//,'');return`<div style="width:100%; height: 100%;"><a href="${y.downloadUrl}" download="${z}" class="download-attachment"><i class="centered-icon fa fa-download"></i></a></div>`}var o={couchdb:k,couch:k},p={},q=Promise.all([a.loadCss('components/slickgrid/slick.grid.css'),a.loadCss('src/util/uploadUi.css')]);return p.uploadDialog=function(t,u){var w=u.mode;t&&w&&o[w]&&(t=o[w](t,u)),t=t||[];var x;return q.then(function(){return new Promise(function(y){function z(J,K){K=K||'';var L='upload/'+(''===K?J.name:K+'/'+J.name),M=f.find(x.getItems(),function(N){return N.name===L});M?(M.file=J,M.color='orange',M.size=J.size||M.size):x.addItem({name:L,file:J,contentType:J.type||j.lookup(L)||'application/octet-stream',size:J.size||0,toDelete:!1,color:'green'})}function A(J,K){return new Promise(function(L){J.file(function(M){z(M,K),L(M)})})}function B(J,K){return K=K||'',J.isDirectory?Promise.resolve().then(function(){var L=J.createReader();return new Promise(function(M){L.readEntries(function(O){for(var R,P=[],Q=0;Q<O.length;Q++)R=O[Q],R.isFile?P.push(A(R,K)):R.isDirectory&&P.push(B(R,K+'/'+R.name));return M(Promise.all(P))})})}):A(J)}var C={editable:!0,enableAddRow:!1,enableCellNavigation:!0,autoEdit:!0,enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:!0,multiColumnSort:!1,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,rowHeight:20},D=[{id:'name',name:'name',field:'name',sortable:!0},{id:'contentType',name:'contentType',field:'contentType',editor:h.Editors.Text,sortable:!0},{id:'size',name:'size',field:'size',sortable:!0},{id:'toDelete',name:'toDelete',field:'toDelete',width:40,editor:h.Editors.Checkbox,formatter:h.Formatters.Checkmark,sortable:!0}];t[0]&&t[0].downloadUrl&&D.push({id:'__download_attachment__',name:'Download',field:'__download_attachment__',sortable:!1,width:30,formatter:n});var E=g('<div class="upload-ui">'),F=g('<div class="dropzone">'),G=g('<input type="checkbox">Select/Unselect Delete</input>');G.on('change',function(){var J=!!this.checked;t.forEach(function(K){('view.json'!==K.name||'data.json'===K.name||'meta.json'===K.name)&&(K.toDelete=J)}),H.invalidateAllRows(),H.render()});var H;c.dialog(E,{buttons:{Cancel:function(){g(this).dialog('close')},Upload:function(){var K=f.filter(t,function(L){return L.file||L.toDelete});y(K),g(this).dialog('close')}},close:function(){y(!1)},resize:function(){H.resizeCanvas()},open:function(){E.append(F),E.append(G),x=new h.Data.DataView,x.beginUpdate(),x.setItems(t,'name'),x.endUpdate(),H=new h.Grid(F,x,D,C),m(H,x)},closeOnEscape:!0,width:700,height:500});var I=0;E[0].addEventListener('dragenter',function(J){J.preventDefault(),J.stopPropagation(),I++,1==I&&F.addClass('drop-over')}),E[0].addEventListener('dragleave',function(J){J.preventDefault(),J.stopPropagation(),I--,I||F.removeClass('drop-over')}),E[0].addEventListener('dragover',function(J){J.preventDefault()}),E[0].addEventListener('drop',function(J){J.stopPropagation(),J.preventDefault(),I=0,E.removeClass('drop-over');for(var M,K=[],L=0;L<J.dataTransfer.items.length;L++)M=J.dataTransfer.items[L].webkitGetAsEntry(),K.push(B(M,M.name));Promise.all(K).then(function(){H.invalidateAllRows(),H.render()})})})})},p});
