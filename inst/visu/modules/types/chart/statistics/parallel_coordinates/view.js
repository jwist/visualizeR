'use strict';define(['modules/default/defaultview','src/util/util','src/util/datatraversing','src/util/context','lib/d3/d3.parcoords','src/util/api','src/util/ui','lodash'],function(a,b,c,e,f,g,h,k){'use strict';function m(){this._id=b.getNextUniqueId(),this._value=new DataArray,this._addedColumns={},this._currentColumns={},this._previousColumns=[]}return b.loadCss('lib/d3/d3.parcoords.css'),$.extend(!0,m.prototype,a,{inDom:function(){this.dom=h.getSafeElement('div').attr({id:this._id,class:'parcoords'});var o=this;e.listen(this.dom[0],[['<li><a><span class="ui-icon ui-icon-refresh"></span>Reset selection</a></li>',function(){o.resetBrush()}]]),this.jpathConfig=$.extend(!0,[],this.module.getConfiguration('colsjPaths')),this.preventHighlight=this.module.getConfigurationCheckbox('options','hide'),this.module.getDomContent().html(this.dom),this.resolveReady()},blank:{value:function(){this.dom.empty()},columns:function(){for(var o=0;o<this._previousColumns.length;o++)delete this._currentColumns[this._previousColumns[o].name];this._previousColumns=[]}},update:{value:function(o){o?(o=o.get(),this._value=o.length?o.resurrect():[]):this._value=[],this.redrawChart()},columns:function(o){if(Array.isArray(o)){for(var p=0;p<o.length;p++)this._currentColumns[o[p].name]=o[p];this._previousColumns=o,this.redrawChart()}}},onActionReceive:{addColumn:function(o){o&&o.name&&o.jpath&&(this._addedColumns[o.name]=o,this.redrawChart())},removeColumn:function(o){o&&o.name&&(delete this._addedColumns[o.name],this.redrawChart())}},onResize:function(){this.dom.css('width',this.width-2),this.redrawChart()},redrawChart:function(){function o(u){p.module.controller.onBrushSelection(u)}var p=this;if(this.createIntermediateData(),this.dom.empty(),this._data&&0<this._data.length){var q=this.module.getConfiguration,r=this.module.getConfigurationCheckbox,s=this.parcoords=f.parcoords()('#'+this._id);s.data(this._data),s.detectDimensions(),this._names&&s.dimensions(this._names),this._color&&s.color(this._color),1e3<this._data.length&&(s.mode('queue'),s.rate(200)),s.render();var t=q('brushMode');s.brushMode(t),'None'!=t&&s.brushPredicate(q('brushPredicate')),r('options','reorder')&&s.reorderable(),r('options','shadow')&&s.shadows(),r('options','brush')||s.on('brush',o),s.on('brushend',o),this._parcoords=s}else this.dom.html('No column to display');this.module.controller.onBrushSelection(this._data)},createIntermediateData:function(){var o=this.getColumns(),p=o.length,q=this.module.getConfiguration('colorjpath'),r=this;q&&(q=b.makejPathFunction(q),this._color=function(E){return E.__color?E.__color:'#000'});var s=this._value,t=s.length;if(g.killHighlight(this.module.getId()),this._highlighted=[],!t)return void(this._data=[]);var u,v=Array(t),w=Array(p);for(u=0;u<p;u++)w[u]=o[u].name.toString();this._names=w;for(var x,y,z=function(E){for(x={},y=s[E],v[E]=x,g.listenHighlight(y,function(F){F?r._highlighted.push(r._data[E]):r._highlighted.splice(r._highlighted.indexOf(r._data[E],1)),r.updateHighlight()},!1,r.module.getId()),B=0;B<p;B++)C=o[B].jpathF(y),x[o[B].name]=C?C.valueOf():C;q&&(x.__color=q(y)||'#000000'),x.__id=E},A=0;A<t;A++){var B,C;z(A)}this._data=v},getColumns:function(){var p,o=[],q={},r=this.jpathConfig;if(r)for(p=0;p<r.length;p++)r[p].jpath&&(q[r[p].name]=$.extend(!0,{},r[p]));for(p in $.extend(q,this._currentColumns,this._addedColumns),q)o.push(q[p]);for(p=0;p<o.length;p++)'function'!=typeof o[p].jpathF&&Object.defineProperty(o[p],'jpathF',{value:b.makejPathFunction(o[p].jpath)});return o},resetBrush:function(){this._parcoords&&(this._parcoords.brushReset(),this.module.controller.onBrushSelection(this._data))},updateHighlight:k.throttle(function(){var n=this._highlighted;if(this.preventHighlight){n=[];for(var o=this.parcoords.brushed(),p=0,q=this._highlighted.length;p<q;p++)-1<o.indexOf(this._highlighted[p])&&n.push(this._highlighted[p])}n.length?this.parcoords.highlight(n):this.parcoords.unhighlight()},20)}),m});
