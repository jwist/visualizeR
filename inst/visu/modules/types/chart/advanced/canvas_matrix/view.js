'use strict';var _Mathmax=Math.max,_Mathceil=Math.ceil,_Mathmin=Math.min,_Mathfloor=Math.floor;define(['jquery','require','modules/default/defaultview','src/util/util','src/util/color','src/util/worker','components/jquery.threedubmedia/event.drag/jquery.event.drag'],function(a,b,c,d,f,g){'use strict';function k(){}return a.extend(!0,k.prototype,c,{init:function(){this.colors=null,this.canvas=document.createElement('canvas'),this.canvasContext=this.canvas.getContext('2d'),this.scaleCanvas=document.createElement('canvas'),this.scaleCanvasContext=this.scaleCanvas.getContext('2d'),this.scaleCanvas.width=40,this.canvasContainer=a('<div />').addClass('matrix-container'),this.scaleContainer=a('<div />').addClass('scale-container'),this.dom=a('<div />').addClass('canvasmatrix-container').append(this.canvasContainer.append(this.canvas)).append(this.scaleContainer.append(this.scaleCanvas)),this.module.getDomContent().html(this.dom),this.squareLoading=250,this.availableZooms=[1,2,3,4,5,6,7,8,9,10],this.buffers={};var m=this;m.accumulatedDelta=0,a(this.canvasContainer).on('mousewheel','canvas',function(n){n.preventDefault();var o=n.originalEvent.detail||n.originalEvent.wheelDelta;m.max&&0<o||m.min&&0>o||(m.accumulatedDelta+=o,void 0!==o&&m.changeZoom(m.accumulatedDelta/1e3,n.offsetX||n.pageX-a(n.target).offset().left,n.offsetY||n.pageY-a(n.target).offset().top))}).on('dblclick',function(n){m.accumulatedDelta=0,m.changeZoom(m.accumulatedDelta/1e3,n.offsetX||n.pageX-a(n.target).offset().left,n.offsetY||n.pageY-a(n.target).offset().top)}),a(this.canvasContainer).drag(function(n,o){n.preventDefault();var p=m.baseShift,q=m.getXYShift();q.x=p.x+o.deltaX,q.y=p.y+o.deltaY,m.doCanvasErase(),m.doCanvasRedraw(),m.launchWorkers(!0)}),a(this.canvasContainer).drag('start',function(n){n.preventDefault(),m.baseShift=a.extend({},m.getXYShift())})},inDom:function(){this.onResize(!0),this.initWorkers().then(this.resolveReady.bind(this)),this.module.controller.initEvents()},onResize:function(m){this.canvasContainer.width(this.width-55),this.canvas.width=this.canvasContainer.width(),this.canvas.height=this.height,m||(this.doCanvasErase(),this.doCanvasRedraw())},doCanvasErase:function(){this.redrawStarted=!1,this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height)},doCanvasRedraw:function(){for(var m=this.getBufferIndices(this.getPxPerCell()),n=m.minXIndexBuffer;n<=m.maxXIndexBuffer;n++)for(var o=m.minYIndexBuffer;o<=m.maxXIndexBuffer;o++)this.doCanvasDrawBuffer(n,o)},getBufferIndices:function(m){var n=this.getPxPerCell(),o=n/m,p=this.getXYShift(),q=0;0>p.x&&(q=_Mathfloor(-p.x/n/this.squareLoading));var r=0;0>p.y&&(r=_Mathfloor(-p.y/n/this.squareLoading));var s=_Mathmin(this.canvasNbX/this.squareLoading-1,(this.canvas.width-p.x)/m/this.squareLoading),t=_Mathmin(this.canvasNbY/this.squareLoading-1,(this.canvas.height-p.y)/m/this.squareLoading),u={minXIndexBuffer:q,minYIndexBuffer:r,maxXIndexBuffer:_Mathceil(s),maxYIndexBuffer:_Mathceil(t)};if(n>m){var v=_Mathceil(this.canvasNbX/this.squareLoading)-1,z=_Mathceil(this.canvasNbY/this.squareLoading)-1,A=u.maxXIndexBuffer-u.minXIndexBuffer,B=u.maxYIndexBuffer-u.minYIndexBuffer;u.minXIndexBuffer=_Mathfloor(_Mathmax(0,u.minXIndexBuffer-A*(o-1))),u.maxXIndexBuffer=_Mathfloor(_Mathmin(v,u.maxXIndexBuffer+A*(o-1)-1)),u.minYIndexBuffer=_Mathfloor(_Mathmax(0,u.minXIndexBuffer-B*(o-1))),u.maxYIndexBuffer=_Mathfloor(_Mathmin(z,u.maxYIndexBuffer+B*(o-1)-1))}return u},getBufferKey:function(m,n,o){return m+'-'+n+'-'+o},doCanvasDrawBuffer:function(m,n){var o=this.getXYShift(),p=this.getPxPerCell(),q=this.getBufferKey(p,m,n);this.buffers[q]&&this.canvasContext.putImageData(this.buffers[q],m*this.squareLoading*p+o.x,n*this.squareLoading*p+o.y)},getPxPerCell:function(m){return this.pxPerCell&&!m?this.pxPerCell:(this.pxPerCell=this.getOriginalPxPerCell(),this.resetZoomPrefetch(this.pxPerCell),this.pxPerCell)},resetZoomPrefetch:function(){var m,n,o;for(n=0;n<this.availableZooms.length;n++)if(this.availableZooms[n]==this.pxPerCell){m=n;break}var p=this.availableZooms.slice(m-2,m).reverse(),q=this.availableZooms.slice(m+1,m+3);for(this.availableZoomsForFetch=[],n=0,o=p.length+q.length;n<o;n++)n%2&&0<p.length||0==q.length?this.availableZoomsForFetch.push(p.shift()):this.availableZoomsForFetch.push(q.shift())},getOriginalPxPerCell:function(){return this.getClosest(this.availableZooms,_Mathmax(1,_Mathmin(this.canvas.width/this.canvasNbX,this.canvas.height/this.canvasNbY)))},getClosest:function(m,n){for(var o=!1,q=0;q<m.length;q++)(!o||0>m[q]-n&&n-m[q]<n-o)&&(o=m[q]);return o},changeZoom:function(m,n,o){var p=_Mathmax(1,this.getClosest(this.availableZooms,this.getOriginalPxPerCell()+this.tanh(m)));if(this.pxPerCell!=p){var q=p/this.pxPerCell,r=this.getXYShift();r.x=n-(n-r.x)*q,r.y=o-(o-r.y)*q,this.pxPerCell=p,this.pxPerCell==this.availableZooms[this.availableZooms.length-1]?(this.max=!0,this.min=!1):this.pxPerCell==this.availableZooms[0]?(this.min=!0,this.max=!1):(this.min=!1,this.max=!1),this.doCanvasErase(),this.launchWorkers(!0),this.doCanvasRedraw()}},tanh:function(m){return m/=15,2.5*this.availableZooms[this.availableZooms.length-1]*m},getXYShift:function(){if(this.xyShift&&!isNaN(this.xyShift.x)&&!isNaN(this.xyShift.y))return this.xyShift;var m=this.getPxPerCell(),n=m*this.canvasNbX,o=m*this.canvasNbY;return this.xyShift={x:_Mathfloor((this.canvas.width-n)/2),y:_Mathfloor((this.canvas.height-o)/2)},this.xyShift},blank:{matrix:function(){this.doCanvasErase(),this.gridData=[],this.canvasNbX=0,this.canvasNbY=0}},update:{matrix:function(m){this.canvas&&(m=m.get(),this.gridData=m.data?m.data:m,this.canvasNbX=this.gridData[0].length,this.canvasNbY=this.gridData.length,this.minmaxworker.postMessage(JSON.stringify(this.gridData)))}},initWorkers:function(){var m=g(b.toUrl('src/util/workers/getminmaxmatrix.js')),n=g(b.toUrl('./worker.js')),o=this;return Promise.all([m,n]).then(function(p){var q=p[0];q.addEventListener('message',function(s){o.minValue=s.data.min,o.maxValue=s.data.max,o.doChangeWorkersData(),o.buffers=[],o.buffersDone=[],o.getHighContrast()||(o.minValue=0,o.maxValue=1),o.redoScale(o.minValue,o.maxValue),o.launchWorkers(!0)}),o.minmaxworker=q;var r=p[1];r.postMessage({title:'init',message:{colors:o.getColors(),squareLoading:o.squareLoading,highcontrast:o.getHighContrast()}}),r.addEventListener('message',function(s){var t=s.data,u=t.pxPerCell,v=t.indexX,z=t.indexY;o.buffers[o.getBufferKey(u,v,z)]=t.data,o.getPxPerCell()==u&&o.doCanvasDrawBuffer(v,z),o.launchWorkers()}),o.workers=r})},getCurrentPxPerCellFetch:function(){return this.currentPxFetch?this.currentPxFetch:this.currentPxFetch=this.getPxPerCell()},incrementPxPerCellFetch:function(){return this.currentPxFetch=this.availableZoomsForFetch.shift(),this.currentPxFetch},launchWorkers:function(m){var n;this.cachedPxPerCell=this.pxPerCell,m?(n=this.getPxPerCell(),this.resetZoomPrefetch(n),this.pxPerCell=this.cachedPxPerCell):n=this.getCurrentPxPerCellFetch(),!this.postNextMessageToWorker(n)&&this.incrementPxPerCellFetch()&&this.launchWorkers()},postNextMessageToWorker:function(m){for(var n=this.getBufferIndices(m),o=n.minXIndexBuffer;o<=n.maxXIndexBuffer;o++)for(var q,p=n.minYIndexBuffer;p<=n.maxYIndexBuffer;p++)if(q=this.getBufferKey(m,o,p),'undefined'==typeof this.buffers[q])return this.doPostNextMessageToWorker(m,o,p),!0;var r=_Mathceil(this.canvasNbX/this.squareLoading)-1,s=_Mathceil(this.canvasNbY/this.squareLoading)-1;return!1},doPostNextMessageToWorker:function(m,n,o){if(!this.buffers[this.getBufferKey(m,n,o)]){var p=this.squareLoading,q=this.squareLoading;(n+1)*this.squareLoading>this.canvasNbX&&(p=this.canvasNbX%this.squareLoading),(o+1)*this.squareLoading>this.canvasNbY&&(q=this.canvasNbY%this.squareLoading),this.buffers[this.getBufferKey(m,n,o)]=this.canvasContext.createImageData(p*m,q*m)}this.workers.postMessage({title:'doPx',message:{pxPerCell:m,indexX:n,indexY:o,buffer:this.buffers[this.getBufferKey(m,n,o)],nbValX:p}})},doChangeWorkersData:function(){this.workers.postMessage({title:'changeData',message:{data:JSON.stringify(this.gridData),min:this.minValue,max:this.maxValue}})},getColors:function(){if(!this.colors){var m=this.module.getConfiguration('colors');m?(1===m.length&&m.push([255,255,255,1]),this.colors=m):this.colors=[[0,0,0,1],[255,255,255,1]]}return this.colors},getHighContrast:function(){return this.highContrast||(this.highContrast=this.module.getConfiguration('highContrast',!1))},redoScale:function(m,n){var o=this.getColors();this.scaleCanvas.height=this.scaleContainer.height()-20,this.scaleCanvas.width=40;for(var p=this.scaleCanvas.height-30,q=(n-m)/(o.length-1),r=p/(o.length-1),s=this.scaleCanvasContext.createLinearGradient(0,0,0,p),t=0;t<o.length;t++)s.addColorStop(t/(o.length-1),f.getColor(o[t])),this.scaleCanvasContext.fillText(Math.round(100*(t*q+m))/100+'',5,0>=r*t?15:r*t-5);this.scaleCanvasContext.fillStyle=s,this.scaleCanvasContext.fillRect(28,5,10,p)},erase:function(){this.dom.remove(),this.highContrast=!1,this.colors=!1,this.workers.terminate(),this.workers=[],this.buffers=[]}}),k});
