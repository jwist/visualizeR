'use strict';var _Mathsin=Math.sin,_Mathcos=Math.cos,_MathPI=Math.PI,_Mathmax=Math.max,_Mathmin=Math.min;require.config({paths:{"d3-plugins":'components/d3-plugins'},shim:{"d3-plugins":'d3'}}),define(['modules/default/defaultview','lodash','src/util/debug','src/util/util','d3','src/util/color','src/util/colorbar','src/util/ui','d3-plugins/hexbin/hexbin'],function(f,g,h,k,o,q,s,t){'use strict';function u(){}function w(Q){try{Q.data[0].x}catch(X){return h.warn('no chart data'),[]}for(var S=[],T=void 0!==Q.data[0].z,U=0;U<Q.data.length;U++)for(var W,V=0;V<Q.data[U].x.length;V++)W=[Q.data[U].x[V],Q.data[U].y[V]],T&&W.push(Q.data[U].z[V]),S.push(W);return S}function A(Q){return void 0===Q||3!==Q.length||0!==Q[0]+Q[1]+Q[2]?!1:!0}function B(Q){for(var R=[],S=0;S<Q.length;S++){var T=Q[S],U=_Mathmin.apply(null,T),V=_Mathmax.apply(null,T);if(0!==U||3!==T.length){R.push(void 0);continue}var W=T.indexOf(U),X=T.indexOf(V),Y=2*(W+X)%3,Z=[0,0,0];Z=H(Z,M(T,W,Y,X)),Z=H(Z,L(T,W,Y,X)),R.push(Z)}return R}function F(Q){for(var R=Array(Q.length),S=0;S<Q.length;S++)if(A(Q[S])){var T=Q[S][2],U=Q[S][0];R[S]=[U+(T-(1&T))/2,T]}return R}function H(Q,R){if(Q.length!==R.length)throw new Error('Array not the same size in addition');for(var S=Q.slice(0),T=0;T<Q.length;T++)S[T]+=R[T];return S}function I(Q,R){for(var S=Q.slice(0),T=0;T<Q.length;T++)S[T]*=R;return S}function J(Q,R){for(var S=Q.slice(0),T=0;T<Q.length;T++)S[T]+=R;return S}function K(Q,R){for(var S=Array(R),T=0;T<S.length;T++)S[T]=Q;return S}function L(Q,R,S,T){return R===S?[0,0,0]:0===S&&1===T||1===S&&0===T?I([1,-1,0],Q[S]):1===S&&2===T||2===S&&1===T?I([0,1,-1],Q[S]):I([-1,0,1],Q[S])}function M(Q,R,S,T){return S===T?[0,0,0]:0===T?I([0,-1,1],Q[T]-Q[S]):1===T?I([1,0,-1],Q[T]-Q[S]):I([-1,1,0],Q[T]-Q[S])}function N(Q,R){for(var S=0,T=0;T<Q.length;T++)Q[T]===R[T]&&Q[T]>S&&(S=Q[T]);return S}function O(Q){return[{x:Q*_Mathcos(-_MathPI/3),y:Q*_Mathsin(_MathPI/3)},{x:Q*_Mathcos(2*_MathPI/3),y:Q*_Mathsin(2*-_MathPI/3)},{x:Q*_Mathcos(_MathPI/3),y:Q*_Mathsin(-_MathPI/3)},{x:Q*_Mathcos(2*-_MathPI/3),y:Q*_Mathsin(2*_MathPI/3)},{x:Q*_Mathcos(Math.PI),y:Q*_Mathsin(Math.PI)},{x:1*Q,y:0*Q}]}return u.prototype=$.extend(!0,{},f,{init:function(){},inDom:function(){this.id=k.getNextUniqueId(),this.dom=t.getSafeElement('div').attr('id',this.id),this.module.getDomContent().html(this.dom),this.resolveReady()},blank:{chart:function(){this.reset()}},update:{chart:function(R){this.ignored=[],this.chart=R.get();var S=w(this.chart);switch(this.originalData=S,this.coordinateSystem=this.module.getConfiguration('coordinateSystem'),this.axesType=this.module.getConfiguration('axesType'),this.layout='vertical',this.coordinateSystem){case'combinatorial':this.origin=[this.module.getConfiguration('originX'),this.module.getConfiguration('originY'),this.module.getConfiguration('originZ')],this.data=S,this._substractOrigin(),this._combinatorialBoundaries(this.data),this.data=B(this.data),this.cubicData=this.data,this.data=F(this.data);break;default:this.data=S;}this._chartData(),this._ignored(),this._normalize(),this._processColors(),this.draw()}},_substractOrigin:function(){for(var R=0;R<this.data.length;R++)this.data[R]=H(this.data[R],I(this.origin,-1))},_combinatorialBoundaries:function(){var R=g.map(this.originalData,0),S=g.map(this.originalData,1),T=g.map(this.originalData,2);this.combXmin=_Mathmin.apply(null,R),this.combYmin=_Mathmin.apply(null,S),this.combZmin=_Mathmin.apply(null,T),this.combXmax=_Mathmax.apply(null,R),this.combYmax=_Mathmax.apply(null,S),this.combZmax=_Mathmax.apply(null,T),this.combXYmax=N(R,S),this.combXZmax=N(R,T),this.combYZmax=N(S,T)},_reMinMax:function(R){this.minX=_Mathmin(this.minX,_Mathmin.apply(null,g.map(R,0))),this.minY=_Mathmin(this.minY,_Mathmin.apply(null,g.map(R,1))),this.maxX=_Mathmax(this.maxX,_Mathmax.apply(null,g.map(R,0))),this.maxY=_Mathmax(this.maxX,_Mathmax.apply(null,g.map(R,1))),this.lenX=this.maxX-this.minX,this.lenY=this.maxY-this.minY},_normalize:function(){var R=g.map(this.data,0),S=g.map(this.data,1),T=_Mathmin.apply(null,R),U=_Mathmin.apply(null,S),V=_Mathmax.apply(null,R),W=_Mathmax.apply(null,S);this.lenX=V-T,this.lenY=W-U;var X=_Mathmin(T,U);0!=X%2&&--X,this.normConstant=-X;for(var Y=0;Y<this.data.length;Y++)this.data[Y][0]+=this.normConstant,this.data[Y][1]+=this.normConstant;this.minX=T+this.normConstant,this.minY=U+this.normConstant,this.maxX=V+this.normConstant,this.maxY=W+this.normConstant},_ignored:function(){for(var R=[],S=0;S<this.data.length;S++)void 0===this.data[S]&&R.push(S);this.totalSize=this.data.length,this.realSize=this.data.length-R.length,g.pullAt(this.data,R),g.pullAt(this.color,R),g.pullAt(this.cubicData,R),g.pullAt(this.originalData,R),g.pullAt(this.label,R)},_processColors:function(){var R=this.module.getConfiguration('gradient'),S=this.module.getConfiguration('stopType');R=g.filter(R,(V)=>void 0!==V.stopPosition),this.stopPositions=g.map(R,'stopPosition'),'percent'===S?(this.colorDomain=g.filter(this.color,(V)=>!isNaN(V)),this.colorDomain=[_Mathmin.apply(null,this.colorDomain),_Mathmax.apply(null,this.colorDomain)]):this.colorDomain=[_Mathmin.apply(null,this.stopPositions),_Mathmax.apply(null,this.stopPositions)],this.stopColors=g(R).map('color').map(q.getColor).value(),this.numberToColor=s.getColorScale({stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:S});for(var T=0;T<this.color.length;T++)if(!isNaN(this.color[T])){var U=this.numberToColor(this.color[T]);this.color[T]=U.color,this.opacity[T]=U.opacity}this.color=this.color.map(function(V){return void 0===V?'lightblue':V}),this.opacity=this.opacity.map(function(V){return void 0===V?1:V})},_fontSize:function(R){function S(V){var W=V.split('\n'),X=W.reduce(function(Y,Z){return _Mathmax(Y,Z.length)},0);return X=_Mathmax(X,W.length),X?2*(R/X):T}var U,T=50;return(U=this.module.getConfiguration('fontSize'))||(U=this.label.reduce(function(V,W){return W?_Mathmin(V,S(W)):V},T)),(0|U)+'px'},_chartData:function(){this.color=[],this.label=[],this.opacity=[];for(var S,R=0;R<this.chart.data.length;R++)S=this.chart.data[R],this.color.push(g.map(S.info,'color')),this.label.push(g.map(S.info,'label')),this.opacity.push(g.map(S.info,'opacity'));this.color=g.flatten(this.color),this.label=g.flatten(this.label),this.opacity=g.flatten(this.opacity),this.chart.axis&&(this.axes=this.chart.axis)},onResize:function(){this.redraw()},draw:function(){if('combinatorial'===this.coordinateSystem&&this.axes&&'none'!==this.axesType){this.axeData={};var R=3;this.axeData.points=[[this.combXmax+R,0,0],[0,this.combYZmax+R,this.combYZmax+R],[0,this.combYmax+R,0],[this.combXZmax+R,0,this.combXZmax+R],[0,0,this.combZmax+R],[this.combXYmax+R,this.combXYmax+R,0]];var S=1,T=2;this.axeData.startPoints=[[this.combXmax+S,0,0],[0,this.combYZmax+S,this.combYZmax+S],[0,this.combYmax+S,0],[this.combXZmax+S,0,this.combXZmax+S],[0,0,this.combZmax+S],[this.combXYmax+S,this.combXYmax+S,0]],this.axeData.endPoints=[[this.combXmax+T,0,0],[0,this.combYZmax+T,this.combYZmax+T],[0,this.combYmax+T,0],[this.combXZmax+T,0,this.combXZmax+T],[0,0,this.combZmax+T],[this.combXYmax+T,this.combXYmax+T,0]],this.axeLabels=[this.axes[0].name,this.axes[1].name+this.axes[2].name,this.axes[1].name,this.axes[0].name+this.axes[2].name,this.axes[2].name,this.axes[0].name+this.axes[1].name],this.axeData.points=B(this.axeData.points),this.axeData.points=F(this.axeData.points),this.axeData.startPoints=B(this.axeData.startPoints),this.axeData.startPoints=F(this.axeData.startPoints),this.axeData.endPoints=B(this.axeData.endPoints),this.axeData.endPoints=F(this.axeData.endPoints);for(var U=0;U<this.axeData.points.length;U++)this.axeData.points[U]=J(this.axeData.points[U],this.normConstant),this.axeData.startPoints[U]=J(this.axeData.startPoints[U],this.normConstant),this.axeData.endPoints[U]=J(this.axeData.endPoints[U],this.normConstant);this._reMinMax(this.axeData.points)}this.redraw()},redraw:function(){function R(ya){return[1.75*(ya[0]*W),1.5*(ya[1]*W)]}function S(){da.attr('transform','translate('+o.event.translate+')scale('+o.event.scale+')')}if(this.data&&0!==this.data.length){var T=this;this.reset();for(var U=this.dom.width()/(2+1.5*this.lenX),V=this.dom.height()/(1.75*(this.lenX+1)),W=_Mathmin(U,V),X=[],Y=0;Y<this.data.length;Y++)X.push(R(this.data[Y]));var Z=g.flatten([R([this.minX-0.3,this.minY-0.8]),R([this.lenX+1.5,this.lenY+1.5])]);this.module.getConfigurationCheckbox('showColorBar','show')&&(Z[0]-=100,Z[2]+=100);var aa=this.width,ba=this.height,ca=o.select('#'+this.id).append('svg').attr('viewBox',Z.join(',')).attr('width',aa).attr('height',ba).style('display','block'),da=ca.append('g'),ea=this.module.getConfiguration('tickMode'),fa=this.module.getConfiguration('tickNumber'),ga=(this.module.getConfiguration('tickValues')||'').split(',').map(function(ya){return+ya});if(this.module.getConfigurationCheckbox('showColorBar','show')){var ha=Z[0],ia=Z[1],ja=s.getSvg({width:50,height:0.95*Z[3]-20,axis:{orientation:'left',ticks:'auto'===ea?fa:void 0,tickValues:'manual'===ea?ga:void 0,order:'asc'},stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:this.module.getConfiguration('stopType')});ja='<g transform="translate('+ha+','+ia+')">'+ja+'</g>',da.html(ja)}var ka=o.hexbin().radius(W),la=T._fontSize(W);if('combinatorial'===this.coordinateSystem&&this.axes)if(da.append('defs').selectAll('marker').data(['normal']).enter().append('marker').attr('id',function(ya){return ya}).attr('viewBox','0 -5 10 10').attr('refX',10).attr('refY',0).attr('markerWidth',10).attr('markerHeight',10).attr('orient','auto').append('path').attr('d','M0,-4L10,0L0,4'),'graph'===this.axesType){var ma=[],na=[],oa=[];for(Y=0;Y<this.axeData.points.length;Y++)ma.push(R(this.axeData.points[Y])),na.push(R(this.axeData.startPoints[Y])),oa.push(R(this.axeData.endPoints[Y]));na=ka(na),oa=ka(oa),ma=ka(ma),da.append('g').selectAll('.axes').data(ma).enter().append('foreignObject').style('pointer-events','none').attr({width:W,height:W}).attr('transform',function(ya){return'translate('+(ya.x-W/2)+','+(ya.y-W/2)+')'}).append('xhtml:div').append('div').style({display:'flex',height:''+W+'px',width:''+W+'px',"box-sizing":'border-box',"align-items":'center',"font-size":la}).attr('class','axe-text').html(function(ya,za){return T.axeLabels[za]}),da.append('g').selectAll('.axe-arrow').data(ma).enter().append('path').attr('class','axe-arrow').attr('marker-end','url(#normal)').attr('d',function(ya,za){return'M'+na[za].x+','+na[za].y+'L'+oa[za].x+' '+oa[za].y})}else if('legend'===this.axesType){var pa=30,ra=O(pa),sa=O(20),ta=K({x:0,y:0},6),ua=20;da.append('g').attr('class','abcd').selectAll('.axes-legend').data(ra).enter().append('foreignObject').style('pointer-events','none').attr({width:ua,height:ua}).attr('transform',function(ya){return'translate('+(ya.x-Z[0]-ua/2)+','+(ya.y+Z[1]+pa-ua/2)+')'}).append('xhtml:div').append('div').style({display:'flex',height:''+W+'px',width:''+W+'px',"box-sizing":'border-box',"font-size":16,"align-items":'center'}).attr('class','axe-corner-text').html(function(ya,za){return T.axeLabels[za]}),da.append('g').selectAll('.axe-arrow-legend').data(ta).enter().append('path').attr('class','axe-arrow-legend').attr('marker-end','url(#normal)').attr('d',function(ya,za){return'M'+(ta[za].x-Z[0]-4)+','+(ta[za].y+Z[1]+pa)+'L'+(sa[za].x-Z[0]-4)+' '+(sa[za].y+Z[1]+pa)})}var va=ka(X);da.append('g').selectAll('.hexagon').data(va).enter().append('path').attr('class','hexagon').attr('d',function(ya){return'M'+ya.x+','+ya.y+ka.hexagon()}).attr('stroke','black').attr('stroke-width','1px').style('fill',function(ya,za){return T.color[za]}).style('fill-opacity',function(ya,za){return T.opacity[za]});var wa=da.append('g').selectAll('foreignObject').data(va).enter().append('foreignObject').style('pointer-events','none').attr({width:W,height:W,transform:function(za){return'translate('+(za.x-W/2)+','+(za.y-W/2)+')'}});if(wa.append('xhtml:div').append('div').style({display:'flex',height:''+W+'px',width:''+W+'px',padding:0,"align-items":'center',"justify-content":'center',"box-sizing":'border-box',"font-size":la}).html(function(ya,za){return T.label[za]}),this.module.getConfigurationCheckbox('enableZoom','yes')){var xa=o.behavior.zoom().scaleExtent([0.2,10]).on('zoom',S);ca.call(xa).on('dblclick.zoom',function(){xa.scale(1),xa.translate([0,0]),xa.event(ca)})}}},reset:function(){this.dom.html('')}}),u});
