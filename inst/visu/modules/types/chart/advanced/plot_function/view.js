'use strict';define(['require','modules/default/defaultview','src/util/util','threejs','src/util/debug','lib/parser/Parser','lib/threejs/TrackballControls'],function(a,b,c,d,f,g){'use strict';function h(){}return $.extend(!0,h.prototype,b,{init:function(){var l=this;this.webgl=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement('canvas').getContext('experimental-webgl')}catch(o){return!1}}();var m=this.module.getConfiguration;this._id=c.getNextUniqueId();var n=$('<div>',{Id:this._id});n.css('display','table').css('height','100%').css('width','100%').css('overflow','hidden'),this.dom=n,this.module.getDomContent().html(this.dom).css('overflow','hidden'),this.zFunctionText=m('function')||'sin(sqrt(0.01*x^2  + 0.01*y^2))*10',this.xMin=m('xMin')||-100,this.xMax=m('xMax')||100,this.yMin=m('yMin')||-100,this.yMax=m('yMax')||100,this.zMin=m('zMin')||-100,this.zMax=m('zMax')||100,this.xRange=this.xMax-this.xMin,this.yRange=this.yMax-this.yMin,this.clearScene(),this.createGraph(),this.resolveReady(),this.doAnimation=!1,this.dom.on('mouseenter',function(){l.doAnimation=!0}),this.dom.on('mouseleave',function(){l.doAnimation=!1})},clearScene:function(){this.scene&&(this.scene.remove(this.graphGeometry),this.scene.remove(this.graphMesh),this.scene.remove(this.floor),delete this.graphGeometry,delete this.graphMesh,delete this.floor)},blank:{function:function(){this.clearScene()}},onResize:function(){if(!this.webgl)return void f.warn('webgl context does not exist');var l=this;this.module.viewReady.then(function(){var m=l.module.getConfiguration,n=m('segments');l.graphMesh&&l.scene.remove(l.graphMesh);var o=d.ImageUtils.loadTexture(a.toUrl('./square.png'));o.wrapS=o.wrapT=d.RepeatWrapping,o.repeat.set(40,40);var p=new d.MeshBasicMaterial({map:o,vertexColors:d.VertexColors,side:d.DoubleSide});l.graphMesh=new d.Mesh(l.graphGeometry,p),l.graphMesh.doubleSided=!0,l.scene.add(l.graphMesh),l.renderer.setSize(l.width,l.height),l.setCamera(),l.setControls(),l.firstAnimation=60,l.animate()})},addFloor:function(l){var m=new d.MeshBasicMaterial({color:136,wireframe:!0,side:d.DoubleSide}),n=new d.PlaneBufferGeometry(1e3,1e3,10,10);this.floor=new d.Mesh(n,m),l.add(this.floor)},update:{function:function(l){this.zFunctionText=l.get(),this.createGraph(),this.onResize()}},animate:function(){var l=this;requestAnimationFrame(l.animate.bind(l)),(l.doAnimation||0<l.firstAnimation)&&(0<l.firstAnimation&&l.firstAnimation--,l.renderer.render(l.scene,l.camera),l.controls.update())},setCamera:function(){var m=this.width/this.height;this.camera=new d.PerspectiveCamera(45,m,0.1,2e4),this.camera.position.set(2*this.xMax,0.5*this.yMax,4*this.zMax),this.camera.up=new d.Vector3(0,0,1),this.camera.lookAt(this.scene.position),this.scene.add(this.camera)},setControls:function(){this.controls=new d.TrackballControls(this.camera,this.renderer.domElement)},createGraph:function(){var l=this,m=l.module.getConfiguration,n=m('segments'),o=g.parse(l.zFunctionText).toJSFunction(['x','y']),q=new d.ParametricGeometry(function(D,E){D=l.xRange*D+l.xMin,E=l.yRange*E+l.yMin;var F=o(D,E);return isNaN(F)?new d.Vector3(0,0,0):new d.Vector3(D,E,F)},n,n,!0);q.computeBoundingBox(),l.zMin=q.boundingBox.min.z,l.zMax=q.boundingBox.max.z,l.zRange=l.zMax-l.zMin;for(var r,s,t,u,v,w=['a','b','c','d'],A=0;A<q.vertices.length;A++)s=q.vertices[A],r=new d.Color(255),r.setHSL(0.7*(l.zMax-s.z)/l.zRange,1,0.5),q.colors[A]=r;for(var A=0;A<q.faces.length;A++){t=q.faces[A],u=t instanceof d.Face3?3:4;for(var B=0;B<u;B++)v=t[w[B]],t.vertexColors[B]=q.colors[v]}l.graphGeometry=q,l.scene=new d.Scene,l.renderer||(l.renderer=l.webgl?new d.WebGLRenderer({antialias:!0}):new d.CanvasRenderer,l.renderer.setClearColor(15658734,1)),l.dom.append(l.renderer.domElement),l.addFloor(l.scene)}}),h});
