'use strict';var _Mathmin=Math.min,_Mathmax=Math.max;define(['src/util/api','src/util/debug','modules/default/defaultview','src/util/util','src/util/ui','lodash','bowser','components/jquery.panzoom/dist/jquery.panzoom','components/jquery-mousewheel/jquery.mousewheel'],function(a,b,d,f,g,k,m){'use strict';function n(){this.lastTransform=[1,0,0,1,0,0]}function q(u){if(6!==u.length)throw new Error('getCssTransform expects array of length 6');return'matrix('+u.join(',')+')'}var s=0.5;return $.extend(!0,n.prototype,d,{init:function(){this.currentPromise=Promise.resolve(),this.toHide=this.toHide||{},this.transforms=this.transforms||{};var A=this;this.dom||(this._id=f.getNextUniqueId(),this.dom=$('<div id="'+this._id+'"></div>').css('height','100%').css('width','100%'),this.module.getDomContent().html(this.dom)),this.dom.off('mouseleave'),this.dom.on('mouseleave',function(){A.highlightOff()}),this.images=[],this.state='done'},blank:{picture:function(A){this.clearImage(A)},image:function(A){this.clearImage(A)},svg:function(A){this.clearImage(A)}},inDom:function(){var A=this.module.getConfiguration('transformThrottling');this.module.controller.setTransformThrottling(A),this.resolveReady()},update:{picture:function(A,B){return this.doImage(B,A,{},!0)},svg:function(A,B){this.doSvg(B,A,{},!0)},image:function(A,B){this.doImage(B,A,{},!0)}},clearImages:function(){if(!this.images)return void(this.images=[]);for(var A=0;A<this.images.length;A++)this.images[A].$panzoomEl.panzoom('destroy');this.dom.html(''),this.images=[]},clearImage:function(A){this.currentPromise=this.currentPromise.then(()=>{var B=k.findIndex(this.images,(C)=>C.name===A);-1===B||(this.images[B].$panzoomEl.panzoom('destroy'),this.images[B].$parent.remove(),this.images.slice(B,1))})},doImage:function(A,B,C,D){var E=this;return this.currentPromise=this.currentPromise.then(function(){return E.addImage(A,B,C)}).then(function(){E.panzoomMode(A),E.reorderImages(),D&&(E.processHighlights(),E.listenHighlights())},function(F){b.warn('panzoom: image failed to load',F)}),this.currentPromise},doSvg:function(A,B,C,D){return C=C||{},C.isSvg=!0,this.doImage(A,B,C,D)},reorderImages:function(){for(var A=0;A<this.images.length;A++)this.images[A].$panzoomEl.css('z-index',parseInt(this.images[A].conf.order)||A)},addImage:function(A,B,C){var D=this;return new Promise(function(E,F){function H(){P.type=K,P.name=I.variable,P.$panzoomEl=J.find('.panzoom'),P.$parent=J,P.$img=L,P.conf=I,P.transform=null,'__highlight__'===P.name&&J.css({"pointer-events":'none'}),D.dom.append(J),'svg'===K?(P.width=this.width(),P.height=this.height()):(P.width=this.width,P.height=this.height);var Q=P.conf.scaling;if('maxIfLarge'===Q&&(P.width>D.width||P.height>D.height?Q='max':Q='no'),'max'===Q?P.width/P.height>D.width/D.height?(P.f=D.width/P.width,P.transform=q([P.f,0,0,P.f,0,0])):(P.f=D.height/P.height,P.transform=q([P.f,0,0,P.f,0,0])):'no'===Q&&(P.f=1,P.transform=q([P.f,0,0,P.f,0,0])),'asHighlight'===Q&&D.himg.f){var R=[D.himg.f,0,0,D.himg.f,D.highlightImage.shiftx*D.himg.f,D.highlightImage.shifty*D.himg.f];P.transform=q(R)}O||D.images.push(P),M&&M.remove(),L.css({transform:P.transform,transformOrigin:'0 0',display:'block'}),L.show(),E()}void 0===B&&(B=a.getData(A));var I=k.find(D.module.getConfiguration('img'),function(Q){return Q.variable===A});if(I=D._completeConf(I,A,C),!I.variable)throw new Error('panzoom: conf is expected to have a variable name');var J=D.dom.find('#'+D.getImageDomId(A));J.find('.panzoom').panzoom('destroy');var K,L,M,N=!!C&&(C.isSvg||'svg'===B.type);0===J.length&&'__highlight__'===A?(J=D.newCanvasDom(A),L=$(D.highlightImage.canvas),J.find('.panzoom').append(L),K='canvas'):'__highlight__'===A?(J.find('canvas').remove(),L=$(D.highlightImage.canvas),J.find('.panzoom').append(L),K='canvas'):0===J.length&&N?(J=D.newSvgDom(A),L=$(B.get()+''),J.find('.panzoom').append(L),K='svg'):N?(M=J.find('svg'),L=$(B.get()+''),J.find('.panzoom').append(L),K='svg'):0===J.length?(J=D.newImageDom(A),L=J.find('img'),K='image'):(M=J.find('img'),L=$('<img style="display: none;"/>'),J.find('.panzoom').append(L),K='image');var O=!1,P=k.find(D.images,function(Q){return Q.name===A});return P&&(O=!0),P=P||{},D.toHide&&D.toHide[I.variable]?(M&&M.hide(),L.remove(),E()):void(L.css('opacity',I.opacity).addClass(I.rendering),'__highlight__'===A?H.call(D.highlightImage.canvas):N?H.call(L):L.on('load',H).on('error',function(Q){M&&M.remove(),F(Q)}).attr('src',B.get()+''))})},processHighlights:function(){var A;this.highlights=null;for(var B=0;B<this.images.length;B++)'__highlight__'!==this.images[B].name&&a.getData(this.images[B].name)._highlightArray&&(A=this.images[B]);if(A){var C=a.getData(A.name);if(C._highlightArray.length!==A.width*A.height)return void b.warn('Panzoom: unexpected highlight length');this._highlightArray=C._highlightArray,void 0===this._highlightArray||f.isArray(this._highlightArray)||(b.warn('_highlightArray should be an Array'),this._highlightArray=void 0),this._highlight=C._highlight||[],'Array'!==f.objectToString(this._highlight)&&(this._highlight=[this._highlight]),this.himg=A,this.highlights={};for(var D=new Map,B=0;B<this._highlight.length;B++)D.set(this._highlight[B],!0);for(B=0;B<C._highlightArray.length;B++){var E=C._highlightArray[B],F=B%A.width,G=0|B/A.width;void 0!==E&&D.get(E)&&(this.highlights[E]?this.highlights[E].data.push(B):this.highlights[E]={data:[B],shiftx:F,shifty:G,shiftX:F,shiftY:G},F<this.highlights[E].shiftx?this.highlights[E].shiftx=F:F>this.highlights[E].shiftX&&(this.highlights[E].shiftX=F),G<this.highlights[E].shifty?this.highlights[E].shifty=G:G>this.highlights[E].shiftY&&(this.highlights[E].shiftY=G))}var H=Object.keys(this.highlights);for(B=0;B<H.length;B++){var I=H[B];this.highlights[I].width=this.highlights[I].shiftX-this.highlights[I].shiftx+1,this.highlights[I].height=this.highlights[I].shiftY-this.highlights[I].shifty+1}}},listenHighlights:function(){var A=this;if(a.killHighlight(this.module.getId()),!!this.highlights){var B=Object.keys(this.highlights);A._highlighted=[];for(var C=0;C<B.length;C++)(function(D){a.listenHighlight({_highlight:B[D]},function(E,F,G,H){Array.isArray(F)||(F=[F]),A._highlighted=E?k(A._highlighted).push(F).flatten().uniq().value():k.filter(A._highlighted,function(I){return-1===F.indexOf(I)}),A._drawHighlight(H)},!1,A.module.getId())})(C)}},_drawHighlight:function(A){var B=this;this._highlighted&&this._highlighted.length?(this.toHide.__highlight__=!1,this.highlightImage=this._createHighlight(this._highlighted)):(this.toHide.__highlight__=!0,this.highlightImage=this.highlightImage||{},this.highlightImage.dataUrl='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='),this.doImage('__highlight__').then(function(){var C=B.module.getConfiguration('highlightStrategy');if('none'!==C&&A!==B.module.getId()){var D=B.highlightImage.canvas.width,E=B.highlightImage.canvas.height,F=B.highlightImage.shiftx,G=B.highlightImage.shifty;F=_Mathmax(F-s*D,0),G=_Mathmax(G-s*E,0);var H;'panzoom'===C?(H=_Mathmin(B.himg.width/D*s,B.himg.height/E*s),H=_Mathmax(1,H)):H=B.lastTransform[0];var I=[H,0,0,H,-H*B.himg.f*F,-H*B.himg.f*G];B.setTransform(I,!0)}})},newImageDom:function(A){return $('<div class="ci-panzoom-parent" id="'+this.getImageDomId(A)+'"><div class="panzoom"><img style="display: none;"/></div></div>')},newCanvasDom:function(A){return $('<div class="ci-panzoom-parent" id="'+this.getImageDomId(A)+'"><div class="panzoom"></div></div>')},newSvgDom:function(A){return $('<div class="ci-panzoom-parent" id="'+this.getImageDomId(A)+'"><div class="panzoom"></div></div>')},getImageDomId:function(A){return'ci-panzoom-image-'+A},panzoomMode:function(A){function B(I,J,K){for(var L=0;L<C.images.length;L++){var M=C.images[L].$img[0].getBoundingClientRect(),N={x:0|(I.clientX-M.left)*C.images[L].width/M.width,y:0|(I.clientY-M.top)*C.images[L].height/M.height};0<=N.x&&N.x<C.images[L].width&&0<=N.y&&N.y<C.images[L].height&&(0===L&&(K.x=N.x,K.y=N.y),J[C.images[L].name]=N)}}var C=this,D=0,E=this.images.length;if(A){var F=k.findIndex(C.images,function(I){return I.name===A});D=-1===F?void 0:F,E=F+1}for(var G=D;G<E;G++){if(C.images[G].$panzoomEl.panzoom({increment:0.1,maxScale:100,minScale:1e-6,duration:0,startTransform:'none',onEnd:function(){'pan'===C.state&&$(this).css('cursor','pointer')}}).css('cursor','pointer'),C.lastTransform){var H=C.images[G].$panzoomEl.panzoom('instance');H.setMatrix(C.lastTransform)}C.images[G].$panzoomEl.off('panzoompan'),C.images[G].$panzoomEl.on('panzoompan',function(I,J){C.lastTransform=J.getMatrix(),C.module.controller.transformChanged(C.lastTransform);for(var K=0;K<C.images.length;K++){'done'===C.state&&(C.images[K].$panzoomEl.css('cursor','move'),C.state='pan');var L=C.images[K].$panzoomEl.panzoom('instance');L!==J&&L.setMatrix(C.lastTransform)}})}C.dom.off('mousewheel.focal'),C.dom.on('mousewheel.focal',function(I){I.preventDefault();var J=1;if(0<C.images.length){var L=C.images[0].$panzoomEl.panzoom('getMatrix')[0];J=0.2*L}var M=I.delta||I.originalEvent.wheelDelta,N=M?0>M:0<I.originalEvent.deltaY;C.images[0].$panzoomEl.panzoom('zoom',N,{increment:J,animate:!1,focal:I}),C.lastTransform=C.images[0].$panzoomEl.panzoom('getMatrix'),C.module.controller.transformChanged(C.lastTransform);for(var P,O=1;O<C.images.length;O++)P=C.images[O].$panzoomEl.panzoom('instance'),P.setMatrix(C.lastTransform);C.rerender()}),C.dom.off('click.panzoom'),C.dom.on('click.panzoom',function(I){if('pan'===C.state)return void(C.state='done');C.state='done',$(this).css('cursor','pointer');var J={shiftKey:I.shiftKey,ctrlKey:I.ctrlKey,altKey:I.altKey},K=Object.assign({},J),L={};if(B(I,L,K),3!==Object.keys(K).length&&C.module.controller.clickedPixel(K),0!==Object.keys(L).length){for(var M=Object.keys(L),N=0;N<M.length;N++)Object.assign(L[M[N]],J);C.module.controller.allClickedPixels(L)}}),C.dom.off('mousemove.panzoom'),C.dom.on('mousemove.panzoom',function(I){var J={shiftKey:I.shiftKey,ctrlKey:I.ctrlKey,altKey:I.altKey};if('pan'!==C.state){var K={},L=Object.assign({},J);B(I,K,L);var M=Object.keys(L);if(3<M.length&&!k.isEqual(DataObject.resurrect(C.lastHoverPixel),L)&&(C.module.controller.hoverPixel(L),C.lastHoverPixel=L,C.highlightOn(L)),3===M.length&&C.highlightOff(),3<M.length&&void 0===C._hl&&C.highlightOn(L),!k.isEmpty(K)&&!k.isEqual(DataObject.resurrect(C.lastAllHoverPixels),K)){for(var N=Object.keys(K),O=0;O<N.length;O++)Object.assign(K[N[O]],J);C.module.controller.allHoverPixels(K),C.lastAllHoverPixels=K}}}),this.dom.off('dblclick'),this.dom.dblclick(function(){for(var I=0;I<C.images.length;I++)C.images[I].$panzoomEl.panzoom('reset'),0===I&&(C.lastTransform=C.images[I].$panzoomEl.panzoom('getMatrix'),C.module.controller.transformChanged(C.lastTransform))})},setTransform:function(A,B){this.lastTransform=A,B||this.module.controller.transformChanged(this.lastTransform);for(var D,C=0;C<this.images.length;C++)D=this.images[C].$panzoomEl.panzoom('instance'),D.setMatrix(this.lastTransform)},_createHighlight:function(A){if(!this.highlights)return null;Array.isArray(A)||(A=[A]);for(var G,B=this.highlights[A[0]].shiftx,C=this.highlights[A[0]].shifty,D=this.highlights[A[0]].shiftx,E=this.highlights[A[0]].shiftY,F=0;F<A.length;F++)G=A[F],B=_Mathmin(B,this.highlights[G].shiftx),C=_Mathmin(C,this.highlights[G].shifty),D=_Mathmax(D,this.highlights[G].shiftX),E=_Mathmax(E,this.highlights[G].shiftY);var H=document.createElement('canvas'),I=E-C+1,J=D-B+1;H.height=I,H.width=J;for(var N,K=H.getContext('2d'),L=K.createImageData(J,I),M=L.data,F=0;F<I*J;F++)N=4*F,M[N]=255,M[N+1]=255,M[N+2]=153,M[N+3]=0;for(var P,O=0;O<A.length;O++)for(P=A[O],F=0;F<this.highlights[P].data.length;F++){N=this.highlights[P].data[F];var Q=N%this.himg.width,R=0|N/this.himg.width,S=Q-B,T=R-C;M[4*(T*J+S)+3]=255}return K.putImageData(L,0,0),{canvas:H,shiftx:B,shifty:C}},highlightOn:function(A){var B=this;if(B._highlightArray){var C=A.x+B.himg.width*A.y,D=B._highlightArray[C];void 0===D?B._hl&&B.highlightOff():B._hl!==D&&(B.module.model.highlightId(B._hl,0),B.module.model.highlightId(D,1),B._hl=D)}},highlightOff:function(){void 0!==this._hl&&(this.module.model.highlightId(this._hl,0),this._hl=void 0)},rerender:k.debounce(function(){for(var u=0;u<this.images.length;u++)(this.images[u].conf.rerender&&-1<this.images[u].conf.rerender.indexOf('yes')||'crisp-edges'===this.images[u].conf.rendering&&m.chrome)&&this.doImage(this.images[u].name)},300),onResize:function(){this.doAllImages()},doAllImages:function(){for(var A=0;A<this.images.length;A++)'svg'===this.images[A].type?this.doSvg(this.images[A].name):this.doImage(this.images[A].name)},getDom:function(){return this.dom},export:function(){var A=this.images.filter((C)=>'image'===C.type||'svg'===C.type),B=A.map((C)=>{var D;return D='image'===C.type?C.$img[0].src:'data:image/svg+xml;base64,'+f.toB64(C.$img.html()),{name:C.name+'',link:{type:'downloadLink',value:D,_options:{filename:C.name+''}}}});g.choose(B,{columns:[{id:'name',name:'name',field:'name'},{id:'link',name:'link',field:'link'}],idField:'name',noSelect:!0,noConfirmation:!0})},onActionReceive:{hide:function(A){var B;B='string'==typeof A?A:A.name,this.toHide[B]||(this.toHide[B]=!0,this.doImage(B))},show:function(A){this.toHide=this.toHide||{};var B;B='string'==typeof A?A:A.name,this.toHide[B]&&(this.toHide[B]=!1,this.doImage(B))},transform:function(A){this.setTransform(A,!0)}},_getDefaultConf:function(){return{opacity:1,"z-index":1,rendering:'Normal',scaling:'max'}},_completeConf:function(A,B,C){if(!A)return this._completeConf(this._getDefaultConf(),B,C);'__highlight__'===B&&(C={"z-index":1e6,scaling:'asHighlight',rendering:'crisp-edges',opacity:0.7}),A.variable=B;var D=k.assign(A,C);return D}}),n});
