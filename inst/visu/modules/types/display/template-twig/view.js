'use strict';define(['jquery','modules/default/defaultview','lib/twigjs/twig','src/util/debug','lodash','src/util/Form','src/util/util'],function(a,b,d,f,g,h,k){'use strict';function l(){}return a.extend(!0,l.prototype,b,{init(){this._changedJpaths=new Set;var m=this.module.getConfiguration('template');this.hasTemplate=new Promise((q)=>{this._resolveTemplate=q}),m&&this._resolveTemplate(),this.dom=a('<div>').css({height:'100%',width:'100%',"user-select":this.module.getConfigurationCheckbox('selectable','yes')?'text':'none'});var n=this.module.getConfiguration('debouncing');if(n)var o=g.debounce(this.submitChange,n).bind(this);else o=this.submitChange.bind(this);var p=this.submit.bind(this);this.form&&this.form.unbind(),this.form=new h(this.dom,{keepFormValueIfDataUndefined:this.module.getConfigurationCheckbox('formOptions','keepFormValueIfDataUndefined')}),this.form.onChange(o),this.form.onSubmit(p),this._values=new DataObject,this.renderPromise||(this.renderPromise=Promise.resolve()),this.renderPromise.then(()=>{this.template=d.twig({data:this.module.getConfiguration('template')})})},inDom(){this.module.getDomContent().html(this.dom),this.resolveReady(),this.rerender()},rerender(){this.render(()=>{this.resetForm()})},clearForm(){this.form.clear()},setForm(m){this.form.setData(m)},resetForm(){this.form.setData(this.currentForm)},setStyle(){var m=this.styleObject;if(m){m instanceof Array||(m=[m]);for(var n=0;n<m.length;n++){if(m[n].input)var o=`input[name="${m[n].input}"],textarea[name="${m[n].input}"],select[name="${m[n].input}"]`;else o=m[n].selector;var p=this.dom.find(o);m[n].attributes&&p.attr(m[n].attributes),m[n].style&&p.css(m[n].style)}}},getForm(){return this.currentForm=this.form.getData(!1)},submitChange(m,n){m=m||{target:{}};var o={data:this.getForm()};this._lastChanged&&(o.previousData=this._lastChanged),this._lastChanged=o.data,o.jpath=m.target.name&&m.target.name.split('.'),m.target.name&&this._changedJpaths.add(m.target.name),this.module.controller.onFormChanged(o,n)},submit(){var m={data:this.getForm(),jpaths:Array.from(this._changedJpaths).map((n)=>n.split('.'))};this._changedJpaths.clear(),this._lastSubmit&&(m.previousData=this._lastSubmit),this._lastSubmit=m.data,this.module.controller.onFormSubmitted(m)},blank:{value(){return this.renderPromise=this.renderPromise.then(()=>{this.dom.hide(),this.getForm()}).catch(()=>{f.warn('Error')}),null},tpl(){return this.renderPromise=this.renderPromise.then(()=>{this.dom.hide(),this.getForm(),this.template=d.twig({data:''})}),null},form:k.noop,style:k.noop},update:{value(m,n){this._values[n]=DataObject.resurrect(m.get()),this.rerender()},tpl(m){var n=m.get().toString();return this.renderPromise.then(()=>{return this.template=d.twig({data:n}),this.rerender(),null}).then(()=>this._resolveTemplate()).catch((o)=>{f.info('Problem with template: '+o)}).then(()=>{this.submitChange()})},form(m,n){return this.formName=n,this.formObject=m,this.hasTemplate.then(()=>this.fillForm(!0))},style(m){this.styleObject=m.resurrect(),this.rerender()}},onActionReceive:{clearForm:function(n){this.clearForm(),n&&this.submitChange()},setForm:function(n){if(!n.data)throw new Error('setForm invalid arguments. Must be object with data property.');this.setForm(n.data),n.submitChange&&this.submitChange()}},fillForm(m){var n=this.form.setData(this.formObject);n.forEach((o)=>this._changedJpaths.add(o)),this.submitChange(null,m)},render(m){var n=this;return this.renderPromise=this.renderPromise.then(()=>{this.formName&&(this._values[this.formName]=this.formObject);var o=this.template.renderAsync(this._values);this.dom.html(o.html);var p=o.render().then(function(){m&&m(),n.setStyle(),n.module.controller.onRendered(n.dom.html())});return this.dom.show(),p}).catch((o)=>{f.warn('Error rendering twig template',o)}),this.renderPromise}}),l});
