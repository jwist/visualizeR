'use strict';define(['modules/default/defaultcontroller','x2js'],function(a,b){'use strict';function c(){this.running=!1,this.runners=[],this.variables=new DataObject,this.converter=new b}return $.extend(!0,c.prototype,a),c.prototype.moduleInformation={name:'Webservice Cron',description:'Cron service allowing to fetch data from the server',author:'Norman Pellet, Luc Patiny, Micha\xEBl Zasso',date:'11.01.2014',license:'MIT',cssClass:'webservice_cron'},c.prototype.start=function(){this.running&&this.stop(),this.doVariables()},c.prototype.stop=function(){if(this.running){for(var d=0,e=this.runners.length;d<e;d++)window.clearInterval(this.runners[d]);this.runners=[],this.variables=new DataObject,this.running=!1}},c.prototype.references={result:{label:'Global result',type:'object'}},c.prototype.events={onUpdateResult:{label:'Updated result',refVariable:['result']}},c.prototype.doVariables=function(){var e,f,g,h,d=this.module.getConfiguration('cronInfos');if(d){for(var j=0,k=d.length;j<k;j++)e=d[j].variable,f=d[j].repeat,g=d[j].url,h=d[j].datatype,this.doAjax(this,e,g,h),this.runners[j]=window.setInterval(this.doAjax,1e3*f,this,e,g,h);this.running=!0}},c.prototype.doAjax=function(d,e,f,g){var h={url:f,dataType:'text'};h.success=function(j){var k;'json'===g?k=JSON.parse(j):'xml'===g&&(k=d.converter.xml_str2json(j)),d.addVar(e,DataObject.check(k,!0)),d.createDataFromEvent('onUpdateResult','result',k),d.module.view.log(!0,e)},h.method='get',h.type='get',h.error=function(){d.module.view.log(!1,e)},$.ajax(h)},c.prototype.addVar=function(d,e){this.variables[d]=e},c.prototype.configurationStructure=function(){return{groups:{group:{options:{type:'list'},fields:{max:{type:'float',title:'Max number of logs',default:10}}},cronInfos:{options:{type:'table',multiple:!0},fields:{variable:{type:'text',title:'Variable',default:''},url:{type:'text',title:'URL',default:''},datatype:{type:'combo',title:'Data type',options:[{title:'Text',key:'text'},{title:'JSON',key:'json'},{title:'XML',key:'xml'}],default:'json'},repeat:{type:'text',title:'Repetition time (s)',default:'60'}}}}}},c.prototype.configAliases={cronInfos:['groups','cronInfos',0],maxLogs:['groups','group',0,'max',0]},c.prototype.onRemove=function(){this.stop()},c});
