"use strict";var _NumberisNaN=Number.isNaN,_slicedToArray=function(){function t(o,d){var h,u=[],m=!0,p=!1;try{for(var f,C=o[Symbol.iterator]();!(m=(f=C.next()).done)&&(u.push(f.value),!(d&&u.length===d));m=!0);}catch(w){p=!0,h=w}finally{try{!m&&C["return"]&&C["return"]()}finally{if(p)throw h}}return u}return function(o,d){if(Array.isArray(o))return o;if(Symbol.iterator in Object(o))return t(o,d);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();define(["jquery","modules/default/defaultview","src/util/debug","lodash","src/util/util","src/util/ui","src/util/color","src/util/api","src/util/typerenderer","slickgrid","src/util/sandbox","src/data/structures","./copyFormatters"],function(t,o,d,u,m,p,h,C,f,w,y,I,R){"use strict";function x(){}function S(W){return!W.colDef}function F(W){W.$container.html(""),W.ignoreMyHighlights=W.module.getConfigurationCheckbox("slickCheck","ignoreMyHighlights");var Y=W.getAllSlickColumns().filter(O),K=u.map(Y,"id");for(var X in W.columnFilters)-1===K.indexOf(X)&&delete W.columnFilters[X];if(W.hiddenColumns||(W.hiddenColumns=Y.map(function(ee){if(ee.colDef&&ee.colDef.hideColumn&&"yes"===ee.colDef.hideColumn[0])return ee.name}).filter(function(ee){return ee})),W.slick.columns=W.getInMainColumns(),W.$rowToolbar=t("<div>").attr("class","rowToolbar"),W.module.getConfigurationCheckbox("toolbar","add")&&(W.$addButton=t("<input type=\"button\" value=\"New\"/>"),W.$addButton.on("click",function(){var ee=W.grid.getColumns(),te=u.findIndex(ee,function(oe){return oe.editor});-1<te&&(W.preventRowHelp(),W.grid.gotoCell(W.slick.data.getLength(),te,!0)),W._openDetails()}),W.$rowToolbar.append(W.$addButton)),W.module.getConfigurationCheckbox("toolbar","update")&&(W.$updateButton=t("<input type=\"button\" value=\"Update\"/>"),W.$updateButton.on("click",function(){W._openDetails()}),W.$rowToolbar.append(W.$updateButton)),W.module.getConfigurationCheckbox("toolbar","remove")&&(W.$deleteButton=t("<input type=\"button\" value=\"Delete\"/>"),W.$deleteButton.on("click",function(){W.deleteRowSelection()}),W.$rowToolbar.append(W.$deleteButton)),W.module.getConfigurationCheckbox("toolbar","showHide")){W.$showHideSelection=t.tmpl("<input type=\"button\" value=\"Show/Hide Column\"/>\n    <div class=\"mutliSelect\" style=\"display:none\">\n        <ul>\n            {{each columns}}\n            \n            <li><input type=\"checkbox\" value=\"${name}\" checked/>${name}</li>\n            {{/each}}\n        </ul>\n    </div>",{columns:Y}),W.columnSelectionShown&&W.$showHideSelection.filter("div").show(),W.$showHideSelection.on("click",function(){W.$showHideSelection.filter("div").toggle(),W.columnSelectionShown=W.$showHideSelection.filter("div").is(":visible"),W.onResize()});for(var Z=0;Z<W.hiddenColumns.length;Z++)W.$showHideSelection.find("input[value=\""+W.hiddenColumns[Z]+"\"]").removeAttr("checked");W.$showHideSelection.find("input[type=\"checkbox\"]").on("change",function(){return this.checked?W.hideColumn(this.value):W.showColumn(this.value),F(W)}),W.$rowToolbar.append(W.$showHideSelection)}W.$actionButtons=Array(W.actionOutButtons.length);for(var Z=0;Z<W.actionOutButtons.length;Z++)(function(ee){W.$actionButtons[ee]=t("<input type=\"button\" value=\""+W.actionOutButtons[ee].buttonTitle+"\"/>"),W.$actionButtons[ee].on("click",function(){W.module.controller.sendActionButton(W.actionOutButtons[ee].actionName,W._getSelectedItems())})})(Z);W.$rowToolbar.append(W.$actionButtons),W.$container.append(W.$rowToolbar),W.module.getConfiguration("toolbar")&&0===W.module.getConfiguration("toolbar").length&&W.$actionButtons&&0===W.$actionButtons.length&&W.$rowToolbar&&W.$rowToolbar.remove(),W.$slickgrid=t("<div>").addClass("flex-1"),W.$container.append(W.$slickgrid),W.slick.groupItemMetadataProvider=new w.Data.GroupItemMetadataProvider,W.slick.plugins.push(W.slick.groupItemMetadataProvider),W.slick.data=new w.Data.DataView({groupItemMetadataProvider:W.slick.groupItemMetadataProvider}),W.slick.data.setModule(W.module),W.grid=new w.Grid(W.$slickgrid,W.slick.data,W.slick.columns,W.slick.options),W.slick.grid=W.grid,W._newSandbox();for(var Z=0;Z<W.slick.plugins.length;Z++)W.grid.registerPlugin(W.slick.plugins[Z]);if("row"===W.module.getConfiguration("slick.selectionModel")?W.grid.setSelectionModel(new w.RowSelectionModel):W.grid.setSelectionModel(new w.CellSelectionModel),W.module.getConfigurationCheckbox("copyPaste","active")&&W.grid.registerPlugin(new w.CellExternalCopyManager({noAutoFocus:W.module.getConfigurationCheckbox("copyPasteOptions","noAutoFocus"),readOnlyMode:W.module.getConfigurationCheckbox("copyPasteOptions","readOnly"),newRowCreator:function(te){if(W.module.getConfigurationCheckbox("copyPasteOptions","newRows")){for(var oe=[],ie=0;ie<te;ie++)oe.push({});W.onActionReceive.addRow.call(W,oe)}},dataItemColumnValueExtractor:function(te,oe){console.log(oe);var ie=R[oe.colDef.copyFormatter];if(ie)return ie.extract(te,oe);if(oe.CpEditor){var le={container:t("<p>"),column:oe,position:{top:0,left:0},grid:W.grid},re=new oe.CpEditor(le);re.loadValue(te);var ne=re.serializeValue();return re.destroy(),ne}}})),W.module.getConfigurationCheckbox("autoColumns","reorder")){var J=new w.RowMoveManager({cancelEditOnDrag:!0});J.onBeforeMoveRows.subscribe(function(ee,te){for(var oe=0;oe<te.rows.length;oe++)if(te.rows[oe]==te.insertBefore||te.rows[oe]==te.insertBefore-1)return ee.stopPropagation(),!1;return!0}),J.onMoveRows.subscribe(function(ee,te){var oe=te.rows;oe=oe.map(function(ne){return W._getItemInfoFromRow(ne).idx});var ie=W._getItemInfoFromRow(te.insertBefore);null!==ie&&(ie=ie.idx),W._makeDataObjects();for(var le=W.slick.data.getItems(),re=0;re<le.length;re++)le[re].__pos=-1===oe.indexOf(re)?re<ie||null===ie?1:3:2;W.slick.data.sort(H);for(var re=0;re<le.length;re++)delete le[re].__pos;W.grid.invalidateAllRows(),W.grid.render(),W.module.model.dataTriggerChange(W.module.data)}),W.grid.registerPlugin(J),W.grid.onDragInit.subscribe(function(ee){ee.stopImmediatePropagation()}),W.grid.onDragStart.subscribe(function(ee,te){var oe=this.module.data.get(),ie=W.grid.getCellFromEvent(ee);if(ie&&(te.row=ie.row,!!oe[te.row])&&!w.GlobalEditorLock.isActive()){ee.stopImmediatePropagation(),te.mode="recycle";var le=W.grid.getSelectedRows();le.length&&-1!=t.inArray(te.row,le)||(le=[te.row],W.grid.setSelectedRows(le)),te.rows=le,te.count=le.length;var re=t("<span></span>").css({position:"absolute",display:"inline-block",padding:"4px 10px",background:"#e0e0e0",border:"1px solid gray","z-index":99999,"-moz-border-radius":"8px","-moz-box-shadow":"2px 2px 6px silver"}).appendTo("body");return te.helper=re,t(te.available).css("background","pink"),re}}),W.grid.onDrag.subscribe(function(ee,te){"recycle"!=te.mode||te.helper.css({top:ee.pageY+5,left:ee.pageX+5})}),W.grid.onDragEnd.subscribe(function(ee,te){"recycle"!=te.mode||(te.helper.remove(),t(te.available).css("background","beige"))})}t(W.grid.getHeaderRow()).delegate(":input","change keyup",u.debounce(function(){var te=t(this).data("columnId");null!=te&&(W.columnFilters[te]=t.trim(t(this).val()),W.columnFilterFunctions[te]=E(W.columnFilters[te]),W.slick.data.refresh())},250)),W.grid.onHeaderRowCellRendered.subscribe(function(ee,te){t(te.node).empty(),t("<input type='text'>").css("width","100%").data("columnId",te.column.id).val(W.columnFilters[te.column.id]).appendTo(te.node)}),W.grid.init(),W._activateHighlights(),W.grid.module=W.module,W.slick.data.syncGridSelection(W.grid,!0),W.module.getConfigurationCheckbox("slickCheck","oneUncollapsed")&&W.slick.groupItemMetadataProvider.onGroupExpanded.subscribe(function(ee,te){this.getData().collapseAllGroups(te.item.level),this.getData().expandGroup(te.item.groupingKey)}),W.slick.data.onRowCountChanged.subscribe(function(){W.grid.updateRowCount(),W.grid.render()}),W.slick.data.onRowsChanged.subscribe(function(ee,te){if(W.hasFilter){var oe=W._getItemsInfo(te.rows);W._runFilter({event:"rowsChanged",rows:oe})}W.grid.invalidateRows(te.rows),W.grid.render()}),W.grid.onAddNewRow.subscribe(function(ee,te){var oe=te.item;W.setNextUniqId(oe,!0),W.slick.data.addItem(oe),W._newRow(oe,te)}),W.grid.onRenderCompleted.subscribe(function(){W._jpathColor()}),W.grid.onViewportChanged.subscribe(function(){function ee(){if(W.lastViewport=W.grid.getViewport(),W.module.getConfigurationCheckbox("slickCheck","rowNumbering")&&!W._preventRowHelp){var te=W.grid.getDataLength();W.$rowHelp.html(Math.min(te,W.lastViewport.bottom-(W.addRowAllowed?2:1)).toString()+"/"+te),W.$rowHelp.fadeIn(),clearTimeout(W.lastRowHelp),W.lastRowHelp=setTimeout(function(){W.$rowHelp.fadeOut()},1e3)}W._preventRowHelp=!1,W._jpathColor(),W._inViewFilter()}setTimeout(function(){var te=W.grid.getViewport();te!==W.lastViewport&&ee()},250),ee()}),W.grid.onMouseEnter.subscribe(function(ee){W._hl&&W.module.model.highlightId(W._hl,0),W.count=void 0===W.count?0:W.count,W.count++,W.hovering=!0;var te=W._getItemInfoFromEvent(ee);if(te){var oe=te.item._highlight;W._hl=oe,oe&&(W.module.model.highlightId(oe,1),q=oe),W.module.controller.onHover(te.idx,te.item)}}),W.grid.onMouseLeave.subscribe(function(ee){W._e=ee,W.count--,W.hovering=!1;var te=W._getItemInfoFromEvent(ee);if(te){var oe=te.item._highlight;oe?W.module.model.highlightId(oe,0):q&&W.module.model.highlightId(q,0)}}),W.grid.onColumnsResized.subscribe(function(){for(var ee=W.grid.getColumns(),te=function(re){ie=W.colConfig.find(function(ne){return ne===ee[re].colDef}),ie&&(ie.width=ee[re].width)},oe=0;oe<ee.length;oe++){var ie;te(oe)}W.grid.invalidate()}),W.grid.onCellChange.subscribe(function(ee,te){if(W.fromPopup)var oe=W.getColumnsGivenEditContext();else var ie=W._getChangedColumn(te.cell);if(!S(ie)){var le=W._getItemInfoFromRow(te.row);if(le){if(W.hasFilter){if(oe)for(var re=0;re<oe.length;re++)W._runFilter({event:"cellChanged",row:le,cell:W._getCell({row:te.row,cell:re}),previous:te.previous,column:oe[re]});else W._runFilter({event:"cellChanged",row:le,cell:W._getCell(te),column:ie,previous:te.previous});W._runFilter({event:"rowsChanged",rows:[le]})}W.module.controller.onRowChange(le.idx,le.item)}}}),W.grid.onClick.subscribe(function(ee,te){var oe=W.grid.getColumns(),ie=W._getItemInfoFromRow(te.row);ie&&oe[te.cell]&&"rowDeletion"!==oe[te.cell].id&&(!oe[te.cell].colDef||!oe[te.cell].colDef.isAction)&&W.module.controller.onClick(ie.idx,ie.item)}),W.grid.onDblClick.subscribe(function(ee,te){var oe=W._getItemInfoFromRow(te.row);W.module.controller.onDoubleClick(oe.idx,oe.item)}),W.grid.onActiveCellChanged.subscribe(function(ee,te){W.lastActiveCell=te.cell,W.lastActiveRow=te.row;var oe=W._getItemInfoFromRow(te.row);if(oe){var ie=W.grid.getColumns();ie[te.cell]&&"rowDeletion"!==ie[te.cell].id&&W.module.controller.onActive(oe.idx,oe.item)}}),W.grid.onColumnsReordered.subscribe(function(){var ee=W.grid.getColumns(),te=W.module.definition.configuration.groups.cols[0],oe=u.map(te,"name"),ie=u.map(ee,"id");if(oe.concat().sort().join()!==ie.concat().sort().join())return void d.warn("Something might be wrong, number of columns in grid and in configuration do not match");W.module.definition.configuration.groups.cols[0]=[];for(var re,le=0;le<ee.length;le++)re=oe.indexOf(ie[le]),-1<re&&W.module.definition.configuration.groups.cols[0].push(te[re])}),W.grid.onSelectedRowsChanged.subscribe(function(ee,te){W.lastSelectedRows=te.rows.slice();var oe=W._getItemsInfo(W.lastSelectedRows);if(W.hasFilter&&W._runFilter({event:"rowsSelected",rows:oe}),oe.length){var ie=oe[W.lastSelectedRows.length-1];W.module.controller.onLastSelectedRow(ie.idx,ie.item)}else W.module.controller.unselectLastRow();W.module.controller.onRowsSelected(u.map(oe,"item"))}),W.grid.onSort.subscribe(function(ee,te){W._makeDataObjects();var oe=te.sortCols?te.sortCols:[{sortCol:te.sortCol,sortAsc:te.sortAsc}];for(var ie=function(de){re=function(ue,ge){return void 0===ue?oe[de].sortAsc?1:-1:void 0===ge?oe[de].sortAsc?-1:1:ue<ge?-1:ge<ue?1:0};var ae=oe[de],se=ae.sortCol.jpath;W.slick.data.sort(re,ae.sortAsc,function(ce){var ue=ce.getChildSync(se);return void 0!==ue&&(ue=ue.get()),ue})},le=oe.length-1;0<=le;le--){var re;ie(le)}W._updateHighlights(),W.grid.invalidateAllRows(),W.grid.render(),W.module.model.dataTriggerChange(this.module.data)}),W.slick.data.beginUpdate();var Q=u.chain(W.module.getConfiguration("groupings")).filter((ee)=>ee&&ee.groupName&&ee.getter).map((ee)=>{var te={};return ee.getter&&1<ee.getter.length?(te.getter=function(oe){return oe.getChildSync(ee.getter)},W._makeDataObjects()):te.getter=ee.getter[0],te.formatter=function(oe){return ee.groupName+": "+oe.value+"  <span style='color:green'>("+oe.count+" items)</span>"},te.aggregateCollapsed=!1,te.lazyTotalsCalculation=!0,te}).value();Q.length&&(W.slick.data.setGrouping(Q),W.module.getConfigurationCheckbox("slickCheck","collapseGroup")&&W.slick.data.collapseAllGroups(0)),W.module.getConfigurationCheckbox("slickCheck","filterColumns")&&W.searchFilter&&W.slick.data.setFilter(W.searchFilter),W.slick.data.setItems(W.module.data.get(),W.idPropertyName),W.slick.data.endUpdate(),W.lastViewport&&!W.module.getConfigurationCheckbox("slickCheck","backToTop")&&W.grid.scrollRowToTop(W.lastViewport.top),!W.module.getConfigurationCheckbox("slickCheck","forgetLastSelected")&&Array.isArray(W.lastSelectedRows)&&W.grid.setSelectedRows(W.lastSelectedRows),u.isUndefined(W.lastActiveRow)||W.module.getConfigurationCheckbox("slickCheck","forgetLastActive")||W.grid.gotoCell(W.lastActiveRow,W.lastActiveCell,!1,!0),W.grid.render(),W._setBaseCellCssStyle(),W.lastViewport=W.grid.getViewport(),W._jpathColor(),W._inViewFilter()}function D(){return"..."}function A(){return"<div style=\"width:100%; height: 100%;\"><a class=\"icon-clickable recycle-bin\"><i class=\"centered-icon fa fa-trash\"></i></a></div>"}function P(W,Y,K,X){if(!K.__group&&(this.module.data.traceSync([Y]),W)){var Z=X.rendererOptions||{};X.renderType&&(Z.forceType=X.renderType),f.render(W,K,X.jpath,Z),this.postRenderer(W,Y,K,X)}}function E(W){var K;if(K=W.match(/^"(.*)"$/),K)return function(ee){return K=K.toLowerCase(),ee=(ee+"").toLowerCase(),ee.match(K[1])};if(K=W.match(/^\/(.+)\/(i?)/),K)return function(ee){return(ee+"").match(new RegExp(K[1],K[2]||void 0))};if(K=W.match(/^([<>=]{1,2})([0-9]+)-([0-9\-:]*)$/),K){K=W.match(/^([<>=]{0,2})([0-9]+)-([0-9]*)-?([0-9]*)/);var X=parseInt(K[2]),Z=parseInt(K[3]),J=parseInt(K[4]);_NumberisNaN(Z)&&(Z=1),_NumberisNaN(J)&&(J=1);var Q=new Date;if(Q.setUTCFullYear(X),Q.setUTCMonth(Z-1),Q.setUTCDate(J),Q.setUTCHours(0),Q.setUTCMinutes(0),Q.setUTCSeconds(0),Q.setUTCMilliseconds(0),"<"===K[1])return function(ee){var te=new Date(ee);return te<Q};if(">"===K[1])return function(ee){var te=new Date(ee);return te>Q};if("<="===K[1])return function(ee){var te=new Date(ee);return te<=Q};if(">="===K[1])return function(ee){var te=new Date(ee);return te>=Q};throw new Error("Invalid date operator")}if(K=W.match(/^([<>=]{1,2})([0-9.-]+)$/),K){if("<"===K[1])return function(ee){return ee<K[2]};if("<="===K[1]||"=<"===K[1])return function(ee){return ee<=K[2]};if(">"===K[1])return function(ee){return ee>K[2]};if(">="===K[1]||"=>"===K[1])return function(ee){return ee>=K[2]};if("=="===K[1]||"="===K[1])return function(ee){return ee==K[2]}}return K=W.match(/^([0-9.-]+)\.\.([0-9.-]*)$/),K?function(ee){return ee>=K[1]&&ee<=K[2]}:function(ee){return(ee+"").toLowerCase().match(W.toLowerCase())}}function O(W){return"rowDeletion"!==W.id&&"_checkbox_selector"!==W.id&&"__selectAndMove"!==W.id}function H(W,Y){return W.__pos-Y.__pos}var N=Symbol("_sgid"),B=[];B.push(m.loadCss("components/slickgrid/slick.grid.css"));var V=Promise.all(B),M=0,L={typerenderer:D,"slick.text":w.Formatters.Text,"slick.percent":w.Formatters.PercentComplete,"slick.percentbar":w.Formatters.PercentCompleteBar,"slick.yesno":w.Formatters.YesNoSelect},U={};for(var G in I)"string"==typeof I[G]&&(U[G]=U[I[G]]);U.string=w.CustomEditors.TextValue,U.number=w.CustomEditors.NumberValue,U.boolean=w.CustomEditors.BooleanValue,U.color=w.CustomEditors.ColorValue,U.date=w.CustomEditors.Date,U.longtext=w.CustomEditors.LongText,U.select=w.CustomEditors.Select,U.ocl=w.CustomEditors.OCL,t.extend(!0,x.prototype,o,{init:function(){var K,Y=this;this.columnFilters={},this.columnFilterFunctions={},this.searchFilter=void 0,this._setScript(""),this.title=this.module.definition.title+"",this.$container?this.$container.html(""):(this._id=m.getNextUniqueId(),this.$rowHelp=t("<div>").attr("class","rowHelp"),this.$container=t("<div>").attr("id",this._id).addClass("main-container"),this.module.getDomContent().html(this.$rowHelp),this.module.getDomContent().append(this.$container),this._setDeleteRowListener()),K=this.module.getConfigurationCheckbox("saveInView","yes")?this.module.getConfiguration("varname"):void 0,this.actionOutButtons=this.module.getConfiguration("actionOutButtons"),this.actionOutButtons=this.actionOutButtons||[],this.actionOutButtons=u.filter(this.actionOutButtons,(X)=>X.actionName&&X.buttonTitle),this.$container.on("mouseleave",function(){Y.module.controller.lastHoveredItemId=null}),this.hiddenColumns=void 0,this.slick={},this.colConfig=this.module.getConfiguration("cols",[],!1).filter(function(X){return X.name}),this.actionColConfig=(this.module.getConfiguration("actionCols")||[]).filter(function(X){return X.name}).map(function(X){return X.isAction=!0,X}),this.idPropertyName=this.module.getConfiguration("idProperty")||N,this.autoIdProperty=!this.module.getConfiguration("idProperty"),"pref"===this.module.getConfiguration("filterType")&&this._setScript(this.module.getConfiguration("filterRow")),this.postRenderer=function(X,Z,J,Q){if(X){var ee={event:"postRender",column:Q,row:{item:J},renderOptions:{}};Y._runFilter(ee),Y.postUpdateCell(X,ee.renderOptions)}},this.actionRenderer=function(X,Z,J,Q){if(X){var ee={event:"renderAction",column:Q,row:{item:J},renderOptions:{icon:Q.colDef.icon,disabled:!1,action:Q.colDef.action,tooltip:Q.colDef.tooltip,backgroundColor:h.array2rgba(Q.colDef.backgroundColor),color:Q.colDef.color,clickMode:Q.colDef.clickMode}};Y._runFilter(ee),X.innerHTML=ee.renderOptions.disabled?"":ee.renderOptions.icon&&ee.renderOptions.icon.startsWith("fa-")?`<div style="width:100%; height: 100%"><a style="display: block; text-align:center;"><i class="fa ${ee.renderOptions.icon} centered-icon"></i></a></div>`:`<div style="width:100%; height: 100%"><a>${ee.renderOptions.icon}</a></div>`;var te=t(X);Y.postUpdateCell(X,ee.renderOptions),te.css("cursor","default"),te.find("a").css("color",ee.renderOptions.color);var oe=te.find("a");oe.attr("title",ee.renderOptions.tooltip),ee.renderOptions.action&&("text"===ee.renderOptions.clickMode?(oe.addClass("icon-clickable"),oe.length&&(oe[0].onclick=function(){C.doAction(ee.renderOptions.action,J)})):"background"===ee.renderOptions.clickMode&&(te.css("cursor","pointer"),te.off("click.action"),te.on("click.action",function(){C.doAction(ee.renderOptions.action,J)})))}},K?C.createData(K,JSON.parse(this.module.getConfiguration("data"))).then((X)=>{X.onChange(()=>{this.module.definition.configuration.groups.data[0].data[0]=JSON.stringify(X)}),Y.resolveReady()}):Y.resolveReady()},postUpdateCell:function(Y,K){var X=t(Y);X.css(K)},preventRowHelp:function(){this._preventRowHelp=!0},deleteRowSelection:function(){for(var J,Y=this.grid.getSelectedRows(),K=this.module.data.get(),X=Array(Y.length),Z=0;Z<Y.length;Z++)J=this._getItemInfoFromRow(Y[Z]),X[Z]=J.idx;X=X.sort();var Q=0,ee=[];for(Z=0;Z<Y.length;Z++){var te=K.splice(X[Z]-Q++,1);te.length&&ee.push(te[0])}this.lastSelectedRows=[],ee.length&&(this._deleteFilter(ee),this.module.controller.onRowsDelete(ee),this.module.data.triggerChange())},getAllSlickColumns:function(){function Y(le){var re;if(X.module.data&&X.module.data.length){var ne=X.module.data.get(0).getChildSync(le);return re=ne instanceof DataString?w.CustomEditors.TextValue:ne instanceof DataNumber?w.CustomEditors.NumberValue:ne instanceof DataBoolean?w.CustomEditors.BooleanValue:U[K(le)],re}}function K(le){var re,ne=le.slice(0);ne.unshift(0);var de=X.module.data.getChildSync(ne);return DataObject.isDataObject(de)&&(re=de.type),re}var X=this,Z=P.bind(this),J=this.colConfig.filter(function(le){return le.name}).map(function(le){var re,ne,de;"auto"===le.editor&&X.module.data?(X.module.data.get().length?(re=le.forceType?U[le.forceType]:Y(le.jpath),re=re||Y(le.jpath),de=K(le.jpath)):(re=w.CustomEditors.DataString,d.warn("Slick grid: using editor based on type when the input variable is empty. Cannot determine type")),ne=re):(re=U[le.editor],ne=re||Y(le.jpath),de=K(le.jpath));var ae=m.evalOptions(le.rendererOptions);return{id:le.name,name:le.name,field:le.name,width:+le.width||void 0,minWidth:+le.minWidth||void 0,maxWidth:+le.maxWidth||void 0,resizable:!0,selectable:!0,focusable:!0,sortable:!0,defaultSortAsc:!0,editor:re,CpEditor:ne,compositeEditor:re===w.CustomEditors.LongText?w.CustomEditors.SimpleLongText:void 0,formatter:L[le.formatter],asyncPostRender:"typerenderer"===le.formatter?Z:X.postRenderer.bind(this),jpath:le.jpath,simpleJpath:1===le.jpath.length,dataType:de,renderType:le.forceType,colDef:le,rendererOptions:ae}});if(J=u.filter(J,(le)=>le.name),u.isEmpty(J)){for(var Q=[],ee=X.module.data.get(),te=0;te<ee.length;te++)Q=u(Q).push(u.keys(ee[te])).flatten().uniq().value();J=u(Q).filter((le)=>"_"!==le[0]).map((le)=>({id:le,name:le,field:le,resisable:!0,selectable:!0,focusable:!0,sortable:!1,editor:Y([le]),CpEditor:Y([le]),dataType:K([le]),jpath:[le],formatter:L.typerenderer,asyncPostRender:Z,colDef:{id:le,jpath:[le]}})).value()}for(var oe=this.getActionColumns(),te=0;te<oe.length;te++)"begin"===oe[te].colDef.position?J.unshift(oe[te]):J.push(oe[te]);if(this.module.getConfigurationCheckbox("autoColumns","remove")&&J.unshift({id:"rowDeletion",width:30,field:"rowDeletion",selectable:!1,resizable:!1,focusable:!1,sortable:!1,formatter:A}),this.module.getConfigurationCheckbox("autoColumns","select")){var ie=new w.CheckboxSelectColumn({cssClass:"slick-cell-checkboxsel"});this.slick.plugins.push(ie),J.unshift(ie.getColumnDefinition())}return this.module.getConfigurationCheckbox("autoColumns","reorder")&&J.unshift({id:"__selectAndMove",name:"",width:40,behavior:"selectAndMove",selectable:!1,resizable:!1,cssClass:"cell-reorder dnd",formatter:function(){return""}}),J},getSlickColumns:function(){var Y=this,K=this.getAllSlickColumns();return K.filter(function(X){return-1===Y.hiddenColumns.indexOf(X.name)})},getInMainColumns:function(){return this.getSlickColumns().filter(function(Y){return!!S(Y)||!Y.colDef.visibility||"main"===Y.colDef.visibility||"both"===Y.colDef.visibility})},getInPopupColumns:function(){return this.getAllSlickColumns().filter(function(Y){return!S(Y)&&("popup"===Y.colDef.visibility||"both"===Y.colDef.visibility)}).filter(function(Y){return Y.editor}).filter(O)},getActionColumns:function(){var Y=this;return this.actionColConfig.map((K)=>{return{id:K.name,name:K.name,width:+K.width||25,minWidth:+K.minWidth||25,maxWidth:+K.maxWidth||25,selectable:!1,resizable:!0,focusable:!1,sortable:!1,formatter:D,asyncPostRender:Y.actionRenderer,colDef:K}})},getColumnsGivenEditContext:function(){return this.fromPopup?this.getInPopupColumns():this.getInMainColumns()},getSlickOptions:function(){var Y=this;return{editable:Y.module.getConfigurationCheckbox("slickCheck","editable"),enableAddRow:Y.module.getConfigurationCheckbox("slickCheck","enableAddRow"),enableCellNavigation:Y.module.getConfigurationCheckbox("slickCheck","editable"),autoEdit:Y.module.getConfigurationCheckbox("slickCheck","autoEdit"),enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:Y.module.getConfigurationCheckbox("slickCheck","forceFitColumns"),multiColumnSort:!0,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,defaultColumnWidth:Y.module.getConfiguration("slick.defaultColumnWidth")||80,dataItemColumnValueExtractor:function(X){return X},explicitInitialization:!0,rowHeight:Y.module.getConfiguration("slick.rowHeight"),showHeaderRow:Y.module.getConfigurationCheckbox("slickCheck","filterColumns"),headerRowHeight:+Y.module.getConfiguration("slick.headerRowHeight")}},_openDetails:function(){var Y=this;if(!this.grid.getEditorLock().isActive()||this.grid.getEditorLock().commitCurrentEdit()){var K=this.getInPopupColumns();if(0!==K.length){var X=t("<div class='item-details-form'></div>");X=t.tmpl("<div class='item-details-form'>\n    {{each columns}}\n    <div class='item-details-label'>\n        ${name}\n    </div>\n    <div class='item-details-editor-container' data-editorid='${id.replace(/[^a-zA-Z0-9_-]/g, \"_\")}'></div>\n    {{/each}}\n\n    <hr/>\n    <div class='item-details-form-buttons'>\n        <button data-action='save'>Save</button>\n        <button data-action='cancel'>Cancel</button>\n    </div>\n</div>",{context:this.grid.getDataItem(this.grid.getActiveCell().row),columns:K}).appendTo("body"),X.keydown(function(Q){Q.which==t.ui.keyCode.ENTER?(Y.fromPopup=!0,Y.grid.getEditController().commitCurrentEdit(),Y.fromPopup=!1,Q.stopPropagation(),Q.preventDefault()):Q.which==t.ui.keyCode.ESCAPE&&(Y.fromPopup=!0,Y.grid.getEditController().cancelCurrentEdit(),Y.fromPopup=!1,Q.stopPropagation(),Q.preventDefault())}),X.find("[data-action=save]").click(function(){Y.fromPopup=!0,Y.grid.getEditController().commitCurrentEdit(),Y.fromPopup=!1}),X.find("[data-action=cancel]").click(function(){Y.fromPopup=!0,Y.grid.getEditController().cancelCurrentEdit(),Y.fromPopup=!1});var Z=t.map(K,function(Q){return X.find("[data-editorid="+Q.id.replace(/[^a-zA-Z0-9_-]/g,"_")+"]")}),J=new w.CompositeEditor(K,Z,{destroy:function(){X.remove()}});this.grid.editActiveCell(J)||X.remove()}}},inDom:function(){},update:{script:function(Y){"invar"===this.module.getConfiguration("filterType")&&(this._setScript(Y.get()),this._runFilter({event:"scriptChanged"})),this.rerender()},data:function(Y,K){this.update.list.call(this,Y,K)},list:function(Y){var X=this;this.module.controller.lastClickedItem=void 0,this.module.data=Y,this._updateHighlights(),this.dataObjectsDone=!1,this.slick.plugins=[],this.slick.options=this.getSlickOptions(),this.generateUniqIds(),this.addRowAllowed=this.module.getConfigurationCheckbox("slickCheck","enableAddRow");var Z=this.module.getConfigurationCheckbox("slickCheck","keepSelected");this.searchFilter=function(le){if(Z){var re=X._getSelectedItems();if(re.find((ue)=>le[X.idPropertyName]===ue[X.idPropertyName]))return!0}for(var ne in X.columnFilters)if(ne!==void 0&&""!==X.columnFilters[ne])try{var de=X.slick.data.getIdxById(le[X.idPropertyName]),ae=X.grid.getColumns()[X.grid.getColumnIndex(ne)],se=u.clone(DataObject.resurrect(ae.jpath));se.unshift(de);var ce=X.module.data.getChildSync(se);if(ce&&ce.get&&(ce=ce.get()),!X.columnFilterFunctions[ne](ce))return!1}catch(ue){return!0}return!0};var J=!0,Q=!1,ee;try{for(var oe,ie,te=this.colConfig[Symbol.iterator]();!(J=(oe=te.next()).done);J=!0)ie=oe.value,R[ie.copyFormatter]&&R[ie.copyFormatter].load()}catch(le){Q=!0,ee=le}finally{try{!J&&te.return&&te.return()}finally{if(Q)throw ee}}V.then(function(){F(X)})}},blank:{list:function(){this.$container.html("")},script:function(){"invar"===this.module.getConfiguration("filterType")&&this._setScript("")}},_newRow:function(Y,K){this.module.controller.onRowNew(this.slick.data.getLength()-1,Y),this.module.model.dataTriggerChange(this.module.data),this._runFilter({row:{item:Y},column:K?K.column:null,cell:null,event:"newRow"})},_setBaseCellCssStyle:function(){var Y=this.grid.getColumns();this.baseCellCssStyle={};for(var K=0;K<Y.length;K++)this.baseCellCssStyle[Y[K].id]="highlighted-cell"},_setDeleteRowListener:function(){var Y=this;this.$container.on("click","a.recycle-bin",function(K){var X=Y.grid.getColumns(),Z=Y.grid.getCellFromEvent(K);if(Y.lastViewport=Y.grid.getViewport(),X[Z.cell]&&"rowDeletion"===X[Z.cell].id){var J=Y._getItemInfoFromRow(Z.row),Q=Y.module.data.get().splice(J.idx,1);Q.length&&(Y._deleteFilter(Q),Y.module.controller.onRowsDelete(Q),Y.module.data.triggerChange())}})},_getItemInfoFromEvent:function(Y){var K=this,X=this.grid.getCellFromEvent(Y);if(!X)return null;var Z=K.slick.data.mapRowsToIds([X.row])[0];return Z?{id:Z,idx:K.slick.data.getIdxById(Z),item:K.slick.data.getItemById(Z)}:null},_getItemInfoFromRow:function(Y){var K=this;if(u.isUndefined(Y))return null;var X=K.slick.data.mapRowsToIds([Y])[0];return X?{id:X,idx:K.slick.data.getIdxById(X),item:K.slick.data.getItemById(X)}:null},_jpathColor:function(){var Y=this;if(Y.lastViewport){var K=Y.module.getConfiguration("colorjPath");if(K&&0<K.length){Y._makeDataObjects();for(var Z,X=Y.lastViewport.top;X<=Y.lastViewport.bottom;X++)if(Z=Y.grid.getDataItem(X),Z&&!0!==Z.__group){var J=Z.getChildSync(K),Q=Y.grid.getCellNode(X,0);J?t(Q).parent().css("background-color",J.get()).addClass("has-color"):t(Q).parent().css("background-color","").removeClass("has-color")}}}},_setScript:function(Y){this.filterScript=Y||"",this.hasFilter=this._hasFilter(),this._newSandbox()},_newSandbox:function(){this._sandbox=new y,this._sandbox.setContext(this._getNewContext());try{this.filter=this._sandbox.run("(function() {"+this.filterScript+"\n})","Slickgrid"+this.module.getId())}catch(Y){this._reportError(Y)}},_runFilter:function(Y){if(this.hasFilter)try{this.filter.call(Y)}catch(K){this._reportError(K)}},_getNewContext:function(){var Y=this;return{getSlick:function(){return Y.slick},getData:function(){return Y.module.data&&Y.module.data.get()},rerender:function(X){Y.rerender(X)},API:C}},rerender:function(Y){this.grid&&(Y?this.grid.invalidateRows(Y):this.grid.invalidateAllRows(),this.grid.render())},_reportError:function(Y){var K="";Y&&Y.stack&&(K=Y.message,Y=Y.stack);var X="Code executor error";this.title&&(X+=" ("+this.title+")"),K&&(X+=": "+K),d.error(X),d.warn(Y)},_inViewFilter:function(){var Y=this;if(Y.hasFilter&&Y.lastViewport)var K=Y._getRowsFromViewport(),X=Y._getItemsInfo(K),Z=Y._runFilter({rows:X,cell:null,event:"inView"})},_deleteFilter:function(Y){this.hasFilter&&this._runFilter({event:"rowsDeleted",rows:Y})},_selectHighlight:function(){if(!this.hovering){var Y=this;if(this.module.getConfigurationCheckbox("slickCheck","highlightScroll")){var K=u.findIndex(this._highlights,function(J){return void 0!==J&&(J===Y._highlighted[0]||J.indexOf&&-1<J.indexOf(Y._highlighted[0]))});if(-1<K){this.lastViewport=this.grid.getViewport();var X=Y.slick.data.getItemByIdx(K),Z=Y.slick.data.getRowById(X[Y.idPropertyName]);if(void 0===Z)return;(Z<this.lastViewport.top||Z>=this.lastViewport.bottom)&&this.grid.scrollRowToTop(Z)}}}},_updateHighlights:function(){this._highlights=u.map(this.module.data.get(),"_highlight")},_drawHighlight:function(){var Y=this;this.grid.removeCellCssStyles("highlight");var K={};this._selectHighlight(),this.lastViewport=this.grid.getViewport();for(var Z,X=this.lastViewport.top;X<=this.lastViewport.bottom;X++)if(Z=this._getItemInfoFromRow(X),Z){var J=Z.item;u.some(Y._highlighted,function(Q){var ee=J._highlight;return Array.isArray(ee)||(ee=[ee]),-1<ee.indexOf(Q)})&&(K[X]=Y.baseCellCssStyle)}this.grid.setCellCssStyles("highlight",K)},_activateHighlights:function(){var Y=this,K=u(this.module.data.get()).map("_highlight").flatten().filter((Z)=>!u.isUndefined(Z)).value();Y._highlighted=[],C.killHighlight(this.module.getId());for(var X=0;X<K.length;X++)(function(Z){C.listenHighlight({_highlight:K[Z]},function(J,Q,ee,te){Y.ignoreMyHighlights&&te===Y.module.getId()||(!Array.isArray(Q)&&(Q=[Q]),Y._highlighted=J?u(Y._highlighted).push(Q).flatten().uniq().value():u.filter(Y._highlighted,function(oe){return-1===Q.indexOf(oe)}),Y._drawHighlight())},!1,Y.module.getId())})(X)},_makeDataObjects:function(){if(!this.dataObjectsDone){for(var Y=this.module.data.get(),K=0;K<Y.length;K++)Y[K]=DataObject.check(Y[K]);this.dataObjectsDone=!0}},_getRowsFromViewport:function(){if(!this.lastViewport)return[];var Y=this.lastViewport.bottom-this.lastViewport.top+1;if(_NumberisNaN(Y)||0>Y)return[];for(var K=Array(Y),X=0;X<K.length;X++)K[X]=this.lastViewport.top+X;return K.filter(function(Z){return 0<=Z})},_getItemsInfo:function(Y){var K=[];if(!this.slick.data)return K;for(var Z,X=0;X<Y.length;X++)Z=this._getItemInfoFromRow(Y[X]),Z&&K.push(Z);return K},_getItems:function(Y){var K=this._getItemsInfo(Y);return u.map(K,"item")},_getChangedColumn:function(Y){return this.getColumnsGivenEditContext()[Y]},_getCell:function(Y){if(!Y||void 0===Y.row||void 0===Y.cell)return null;var K=this._getItemInfoFromRow(Y.row),X=this.getColumnsGivenEditContext()[Y.cell].jpath.slice();X.unshift(K.idx);var Z=this.module.data.getChildSync(X);return void 0!==Z&&(Z=Z.get()),Z},_getSelectedItems:function(){return this._getItems(this.grid.getSelectedRows())},onResize:function(){this.grid&&this.grid.resizeCanvas(),this.$rowHelp.css({bottom:0})},getNextIncrementalId:function(){return++M},generateUniqIds:function(){if(this.module.data)for(var Y=this.module.data.get(),K=0;K<Y.length;K++)this.setNextUniqId(Y[K])},setNextUniqId:function(Y,K){if(!Y[this.idPropertyName])if(this.autoIdProperty&&(void 0===Y[this.idPropertyName]||K))Y[this.idPropertyName]=++M;else if(!this.autoIdProperty&&!Y[this.idPropertyName])throw new Error(`An element of slick grid input does not define it's id property "${this.idPropertyName}"`)},_hasFilter:function(){return u.some(this.filterScript.split("\n"),function(Y){var K=Y.replace(" ","");return!!K&&!K.match(/^\s*\/\/a/)})},_findItem:function(Y){var K;if(!this.module.data)return null;var X=this.module.data.get();return"function"==typeof Y?X.find(Y):(K=u.isNumber(Y)||Y instanceof DataNumber?X[Y]:"string"==typeof Y||Y instanceof DataString?{[this.idPropertyName]:Y+""}:Y,K)},exportToTabDelimited:function(){this._makeDataObjects();var Y=this.grid.getColumns(),K=[{key:"all",description:"Export entire list"}];this.module.getConfigurationCheckbox("slickCheck","filterColumns")&&K.push({key:"filtered",description:"Export filtered list"}),this.module.getConfigurationCheckbox("slickCheck","editable")&&K.push({key:"selected",description:"Export selected elements"});var X;return p.choose(K,{autoSelect:!0,noConfirmation:!0}).then((Z)=>{if(Z){Z+="",X="filtered"===Z?this.slick.data.getItems(!0):"selected"===Z?u.map(this._getItemsInfo(this.lastSelectedRows||[]),"item"):this.slick.data.getItems();var ee,te,J="",Q=[];for(ee=0;ee<Y.length;ee++)Y[ee].jpath&&Q.push(Y[ee].name||"");for(J+=Q.join("\t")+"\r\n",ee=0;ee<X.length;ee++){for(Q=[],te=0;te<Y.length;te++){var oe=Y[te].jpath;if(oe){var ie=X[ee].getChildSync(oe,!1);ie=ie?ie.get():"","string"==typeof ie&&(ie=ie.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")),Q.push(ie)}}J+=Q.join("\t")+"\r\n"}return J}})},showColumn:function(Y){this.hiddenColumns&&(-1!==this.hiddenColumns.indexOf(Y)||(this.hiddenColumns.push(Y),F(this)))},hideColumn:function(Y){if(this.hiddenColumns){var K=this.hiddenColumns.indexOf(Y);-1<K&&(this.hiddenColumns.splice(K,1),F(this))}},getRowIndexes:function(Y){var X,Z,K=this.module.data.get();if("function"==typeof Y)Z=K.filter(Y);else if("all"===Y){X=Array(this.slick.data.getLength());for(var J=0;J<X.length;J++)X[J]=J}else Array.isArray(Y)&&(!Y.length||Y.length&&("number"==typeof Y[0]||Y[0]instanceof DataNumber))?X=Y:Array.isArray(Y)?Z=Y.map(this._findItem.bind(this)):"number"==typeof Y||Y instanceof DataNumber?X=[Y]:Y?Z=[this._findItem(Y)]:X=[];return Z&&(X=Z.filter((Q)=>Q).map((Q)=>{return this.slick.data.getRowById(Q[this.idPropertyName])})),X},onActionReceive:{appendRow:function(Y){this.onActionReceive.addRow.call(this,Y)},prependRow:function(Y){if(this.slick.data){Array.isArray(Y)||(Y=[Y]);for(var X,K=0;K<Y.length;K++)X=Y[K],X=DataObject.resurrect(X),this.setNextUniqId(X,!0),this.slick.data.insertItem(0,X),this._newRow(X)}},addRow:function(Y){if(this.slick.data){Array.isArray(Y)||(Y=[Y]);for(var X,K=0;K<Y.length;K++)X=Y[K],X=DataObject.resurrect(X),this.setNextUniqId(X,!0),this.slick.data.addItem(X),this._newRow(X)}},rerender:function(){this.grid&&(this.grid.invalidateAllRows(),this.grid.render())},hoverRow:function(Y){var K=this._findItem(Y);if(K&&K[this.idPropertyName]){var X=this.slick.data.getRowById(K[this.idPropertyName]),Z=this.slick.data.getIdxById(K[this.idPropertyName]);K=this.slick.data.getItem(Z),this.module.controller.onHover(Z,K),this.grid.scrollRowToTop(X)}},unsetActiveRow:function(){this.grid.setSelectedRows(this.grid.getSelectedRows().filter((Y)=>Y!==this.lastActiveRow)),this.grid.resetActiveCell(),this.module.controller.unselectRow()},selectRow:function(Y){"number"==typeof Y&&(Y={row:Y});var K=this._findItem(Y.row);if(K&&K[this.idPropertyName]){var X=this.slick.data.getRowById(K[this.idPropertyName]),Z=this.slick.data.getIdxById(K[this.idPropertyName]);K=this.slick.data.getItem();var J=Y.column;"number"!=typeof J&&(J=this.slick.columns.findIndex((Q)=>Q.id===J),-1===J&&(J=0)),this.module.controller.onClick(Z,K),u.isUndefined(X)||(this.grid.scrollRowToTop(X),this.grid.setActiveCell(X,J||0))}},selectRows:function(Y){var K=this.getRowIndexes(Y);K&&this.grid.setSelectedRows(K)},unselectRows:function(Y){var K=this.getRowIndexes(Y),X=this.grid.getSelectedRows(),Z=u.difference(X,K);this.grid.setSelectedRows(Z)},scrollToRow:function(Y){var K=this.getRowIndexes(Y),X=_slicedToArray(K,1),Z=X[0];this.grid.scrollRowToTop(Z)},selectRowsAdd:function(Y){var K=this.getRowIndexes(Y)||[],X=this.grid.getSelectedRows(),Z=u.uniq(u.concat(K,X));this.grid.setSelectedRows(Z)},showColumn:function(Y){this.showColumn(Y)},hideColumn:function(Y){this.hideColumn(Y)}}});var q="";return x});
