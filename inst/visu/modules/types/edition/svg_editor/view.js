'use strict';require.config({paths:{svgsanitize:'lib/svg-edit/sanitize'},shim:{svgsanitize:['lib/svg-edit/svgedit','lib/svg-edit/browser','lib/svg-edit/svgutils'],"lib/svg-edit/svgutils":['lib/svg-edit/browser','lib/svg-edit/svgtransformlist','lib/svg-edit/units'],"lib/svg-edit/svgtransformlist":['lib/svg-edit/browser']}}),define(['require','src/util/api','lodash','modules/default/defaultview','src/util/debug','src/util/typerenderer','src/util/util','src/util/datatraversing','lib/svg-edit/embedapi','svgsanitize'],function(b,c,d,e,f,g){'use strict';function h(){var t=this;this.svgCanvas=null,this.iframeLoaded=$.Deferred(),this.iframeLoaded.done(function(){t.svgCanvas.zoomChanged(window,'canvas')})}var l=d.throttle(function(){function t(y){v[0].module.getConfigurationCheckbox('saveSvg','yes')&&(v[0].module.definition.configuration.groups.group[0].svgcode=[y]),v[0].module.controller.onChange(y)}function u(y,z){return z?void f.error('Unable to get svg from iframe'):void t(y)}var v=arguments;if(v[0]._configCheckBox('editable','isEditable'))setTimeout(function(){v[0].svgCanvas.getSvgString()(u)},0);else{var w=v[0].dom.clone(),x=w[0].getAttribute('viewBox').split(' ');w.attr('width',x[2]).attr('height',x[3]).removeAttr('viewBox'),w=w.wrap('<p/>').parent().html(),t(w)}},1e3),m=['animate','set','animateMotion','animateColor','animateTransform'],n={begin:'indefinite',options:{clearOnEnd:!1,persistOnEnd:!1,clearAnimationTagsOnEnd:!1,clearAnimationTagsBeforeBegin:!1}},o=['options','tag','attributes'],p=['click','dblclick','mouseenter','mouseleave'],q={},r={},s={};return $.extend(!0,h.prototype,e,{_renderSvg:function(u){var v=this;return u=u?u.get()+'':v.module.getConfiguration('svgcode'),u?new Promise((w)=>{if(this._configCheckBox('editable','isEditable'))this.dom&&this.dom.remove(),this.svgCanvas=null,this.dom=$('<iframe src="lib/svg-edit/svg-editor.html?extensions=ext-xdomain-messaging.js'+window.location.href.replace(/\?(.*)$/,'&$1')+'"></iframe>'),this.module.getDomContent().html(this.dom),this.dom.bind('load',function(){var y=v.dom[0];return v.svgCanvas=new EmbeddedSVGEdit(y),v.iframeDoc=y.contentDocument||y.contentWindow.document,v.svgEditor=y.contentWindow.svgEditor,y.contentWindow.svgedit.options={},v.svgCanvas.bind('changed',function(){v.svgEditor.showSaveWarning=!1,v._saveSvg()}),v._loadSvg(),v.iframeLoaded.resolve(),v.onResize(),w()});else{var x=v.module.getDomContent();return g.render(x,{type:'svg',value:u}).catch(function(){x.html('<svg></svg>')}).then(function(){v.dom=x.find('svg')}).then(w)}}).then(()=>{this.modifySvgFromArray(this.queuedSvgModifier,!0)}):Promise.resolve()},init:function(){this._renderSvg().then(()=>{this.resolveReady()})},onResize:function(){this._configCheckBox('editable','isEditable')&&this.dom&&(this.dom.parent().css({overflow:'hidden'}),this.dom.height(this.height).width(this.width),this.svgCanvas&&this.svgCanvas.zoomChanged(window,'canvas'))},update:{svgModifier:function(u){this.queuedSvgModifier=u,this.modifySvgFromArray(this.queuedSvgModifier,!0)},svgInput:function(u){this._renderSvg(u).then(this._saveSvg.bind(this))}},addAnimation:function(u,v){var w=this,x=$([]);if(v.attributes){u.attr('id');if(v.tag=v.tag||'animate',-1!==m.indexOf(v.tag)){Array.isArray(v.attributes)||(v.attributes=[v.attributes]),v=d.defaults(v,n);var z=w.getHighlightId(u),A={};for(var B in v)-1===o.indexOf(B)&&(A[B]=d.cloneDeep(v[B]));for(var C=function(G){v.attributes[G]=d.defaults(v.attributes[G],A),u.each(function(){var H=document.createElementNS('http://www.w3.org/2000/svg',v.tag);for(var I in v.attributes[G]){var J=v.attributes[G][I];J='function'==typeof J?J.call():J,H.setAttributeNS(null,I,J)}$(this).append(H)}),E=u.children(':last-child'),x=x.add(E)},D=0;D<v.attributes.length;D++){var E;C(D)}x.each(function(F,G){this.addEventListener('endEvent',function(){if(s[z]=!1,v.options.persistOnEnd&&('animate'===v.tag?u.attr(this.getAttribute('attributeName'),this.getAttribute('to')):f.warn('Could not persist animation')),v.options.clearAnimationTags&&w.$getAnimationTags(u).remove(),v.options.clearOnEnd){var H=v.options.clearOnEnd.timeout||0;setTimeout(function(){$(G).remove(),w._saveSvg()},H)}else;}),this.addEventListener('repeatEvent',function(){}),this.addEventListener('beginEvent',function(){v.options.clearAnimationTagsBeforeBegin&&(w.$getAnimationTags(u).not(x).remove(),r[z]=0,s[z]=!0)}),'indefinite'===this.getAttribute('begin')&&this.beginElement()})}}},addAnimations:function(u,v){if(Array.isArray(v))for(var w=0;w<v.length;w++)this.addAnimation(u,v[w]);else this.addAnimation(u,v)},setAttributesOneByOne:function(u,v){var w=function(z){'function'==typeof v[z]?u.each(function(){this.setAttribute(z,v[z].call())}):u.attr(z,v[z])};for(var x in v)w(x)},removeStyleProperties:function(u,v){u.each(function(){for(var w in v)this.style.removeProperty(w)})},modifySvgFromArray:function(u,v){var w=this;if(u){Array.isArray(u)||(u=[u]),this.$svgcontent=this._configCheckBox('editable','isEditable')?$(w.iframeDoc).find('#svgcontent'):w.dom,w.module._data=[];for(var x=0;x<u.length;x++)this.modifySvgFromObject(u[x],v);w._saveSvg()}},modifySvgFromObject:function(u,v){function w(){$(this).css('cursor','pointer'),A.module.controller.onHover(u.info||{})}function x(){$(this).css('cursor','default')}function y(){A.module.controller.onClick(u.info||{})}function z(I){if(!s[H]){var J={};J.tag='animateTransform',J.options={clearOnEnd:!1,persistOnEnd:!1},J.attributes={attributeName:'transform',type:'scale',from:'1.0',dur:'0.2s',additive:'sum',accumulate:'sum',fill:'freeze'},I&&0===r[H]?(J.options.clearAnimationTags=!1,J.attributes.to='1.25',r[H]++):!I&&1===r[H]&&(J.options.clearAnimationTags=!1,J.attributes.to='0.8',r[H]--),A.addAnimation(D,J)}}var A=this,B=u.selector;if(B){var C='string'==typeof u._highlight;u.info&&(A.module._data=u.info);var D,E=this.$svgcontent;if(D=E.find(B),0===D.length&&'#'!==B[0]&&(D=E.find('#'+B)),0===D.length)return void f.warn('The svg element to modify was not found',B);if(u.innerVal&&D.html(u.innerVal),u.attributes&&!u.animation)d.some(u.attributes,(I)=>'function'==typeof I)?this.setAttributesOneByOne(D,u.attributes):D.attr(u.attributes),A.removeStyleProperties(D,u.attributes);else if(u.animation&&!u.attributes)A.addAnimations(D,u.animation);else if(u.attributes&&u.animation&&!u.animation.attributes){for(var F in u.animation.attributes=[],u.attributes){var G={};G.attributeName=F,G.to=u.attributes[F],u.animation.attributes.push(G)}delete u.attributes,A.addAnimations(D,u.animation)}else u.attributes&&u.animation&&u.animation.attributes&&(D.attr(u.attributes),A.removeStyleProperties(D,u.attributes),A.addAnimations(D,u.animation));if(v){if(C){var H=A.getHighlightId(D);c.killHighlight(H),c.listenHighlight({_highlight:u._highlight},z,!1,H),r[H]=r[H]||0}(function(I){I.off('mouseenter.svgeditor.varout').off('mouseleave.svgeditor.varout').off('click.svgeditor.varout'),u.info&&I.on('mouseenter.svgeditor.varout',w).on('mouseleave.svgeditor.varout',x).on('click.svgeditor.varout',y);for(var J=0;J<p.length;J++)u.hasOwnProperty(p[J])&&function(K){I.off(K),I.on(K,function(){u[K].selector||(u[K].selector=u.selector),A.modifySvgFromArray(u[K],!1)})}(p[J])})(D)}}},getHighlightId:function(u){u.map(function(){return this.getAttribute('id')}).toArray().join(',')},getDom:function(){return this.dom},_loadSvg:function(){var u=this.module.getConfiguration('svgcode');this.svgCanvas.setSvgString(u),this.module.controller.onChange(u)},_saveSvg:function(){l(this)},_configCheckBox:function(u,v){return this.module.getConfiguration(u)&&d.find(this.module.getConfiguration(u),(w)=>w===v)},memorizeAnim:function(u,v){v&&u.attributes&&u.attributes.to&&u.attributes.attributeName&&(q[v]=q[v]||{},q[v][u.attributes.attributeName]=q[v][u.attributes.attributeName]||{},q[v][u.attributes.attributeName].to=u.attributes.to)},rememberAnim:function(u,v){u.attributes&&!u.attributes.from&&v&&q[v]&&q[v][u.attributes.attributeName]&&q[v][u.attributes.attributeName].to&&(u.attributes.from=q[v][u.attributes.attributeName].to)},$getAnimationTags:function(u){for(var v,w=0;w<m.length;w++)v=0===w?u.find(m[w]):v.add(u.find(m[w]));return v}}),h});
