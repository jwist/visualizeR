'use strict';define(['modules/default/defaultview','src/util/datatraversing','src/util/api','lib/formcreator/formcreator','lodash'],function(a,b,c,d,e){'use strict';function f(){}return $.extend(!0,f.prototype,a,{init:function(){this.dom=$('<div />'),this.module.getDomContent().html(this.dom),this.callback=null},inDom:function(){function h(){if(!k.lockEvents){var w,x,y=new DataObject(this.getValue(),!0);k.formValue=y;var B,z=k.module.getDataFromRel('input_object'),A=k.module.getConfiguration('structure')||[],C=new DataObject;if(!z)C=y;else if(k.module.getConfiguration('replaceObj')){for(w=0,x=A.length;w<x;w++)B=A[w].groups.general[0].searchOnField[0],z.setChild(B,k.form.sectionElements.main[0].groupElements.main[0].fieldElements[A[w].groups.general[0].name[0]][0].value,[k.module.getId()]);k.module.model.dataTriggerChange(z)}else for(w=0,x=A.length;w<x;w++)B=A[w].groups.general[0].searchOnField[0],C.setChild(B,k.form.sectionElements.main[0].groupElements.main[0].fieldElements[A[w].groups.general[0].name[0]][0].value);return C}}var r,k=this,m=this.module.getConfiguration('structure')||[],n=this.module.getConfiguration('tpl_file'),o=this.module.getConfiguration('trigger'),p=this.module.getConfiguration('tpl_html'),s={},t={sections:{main:{groups:{main:{options:{type:'list',multiple:!1},fields:d.makeStructure(m)}}}}};r=n?$.get(n,{}):p;var u=function(){var x=h.call(this);k.module.controller.formTriggered(x)},v=function(){var x=h.call(this);k.module.controller.valueChanged(x)};$.when(r).done(function(w){w='<form><div style="position: relative;" class="form-sections-wrapper form-section-section-container"><div class="form-section" data-form-sectionname="main"><div class="form-section-group-container"><div class="form-group" data-form-groupname="main">'+w+'</div></div></div></div></form>';var x=d.makeForm();switch(o){case'btn':case'both':var y=k.module.getConfiguration('btnLabel');x.addButton(y,{color:'blue'},u.bind(x));case'change':var z=k.module.getConfiguration('debounce');s.onValueChanged=0<z?e.debounce(v,z):v;}x.init(s),x.setStructure(t),x.onStructureLoaded().done(function(){x.fill({})}),x.onLoaded().done(function(){x.setTpl(w),k.dom.html(x.makeDomTpl()),x.inDom(),x.dom.submit(function(A){A.preventDefault()}),u.call(x),k.resolveReady()}),k.form=x})},update:{input_object:function(h){var k=this;this.newValue(h),this.module.model.dataListenChange(h,function(){k.newValue(this)},'input_object')}},newValue:function(h){var n,k=this,m=this.module.getConfiguration('structure')||[];k.lockEvents=!0,k.nb=0;for(var o=0,p=m.length;o<p;o++)n=m[o].groups.general[0].searchOnField[0],function(q,r){k.nb++,h.getChild(r,!0).then(function(s){k.form.sectionElements.main[0].groupElements.main[0].fieldElements[m[q].groups.general[0].name[0]][0].value=s?s.get?s.get():s.toString():'',k.nb--,0==k.nb&&(k.lockEvents=!1)})}(o,n)}}),f});
