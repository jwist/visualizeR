'use strict';define(['require','lodash','modules/default/defaultview','src/util/api','src/util/debug'],function(b,c,d,f,g){'use strict';function h(){}function j(){this.lastHoveredAtom&&(f.highlightId(this.lastHoveredAtom.label,0),this.lastHoveredAtom=null)}var k={};window.addEventListener('message',function(n){try{var o=JSON.parse(n.data)}catch(s){return}if('jsmol'===o.module){var p=o.id;if(!k[p])return void g.error('No view with ID '+p);var r,q=k[p];switch(o.type){case'ready':q.resolveReady();break;case'message':q.module.controller.onNewMessage(o.message);break;case'atomClick':r=q.parseAtom(o.message),q.module.controller.onAtomClick(r);break;case'atomHover':r=q.parseAtom(o.message),q._doHighlights(r),q.module.controller.onAtomHover(r);break;case'error':g.warn('An error message was received',o.message);break;case'execSync':q.module.controller.onSyncExecDone(o.message);break;default:g.error('Message type not handled: ',o.type);}}}),$.extend(!0,h.prototype,d,{init:function(){var o=this,p=this.module.getId();k[p]=this;var q=this.module.getConfiguration('prefs').includes('webgl');this.dom=$('<iframe>',{src:b.toUrl('./jsmol.html?webgl='+q)}).css({border:0,height:'100%',width:'100%'}),this.module.getDomContent().html(this.dom).css({overflow:'hidden',height:'100%',width:'100%',display:'block'}),this._highlights=this._highlights||[],this.dom.bind('load',function(){o.postMessage('init',{id:p})})},onResize:function(){},inDom:function(){var o=this;this.dom.parent().on('mouseleave',function(){o.lastHoveredAtom&&(f.highlightId(o.lastHoveredAtom.label,0),o.lastHoveredAtom=null)})},blank:{data:function(){this.postMessage('blank','')}},update:{data:function(o){var p=this;this.module.data=o,p.postMessage('setMolFile',{_modelLoad:o.get(),_lattice:o._lattice,_script:o._script}),p.module.getConfiguration('script')&&p.postMessage('executeScript',[p.module.getConfiguration('script')]),p.module.getConfiguration('syncScript')&&p.postMessage('executeScriptSync',[p.module.getConfiguration('syncScript')]),this._activateHighlights()}},onActionReceive:{jsmolscript:function(o){this.executeScript(o)},jsmolscriptSync:function(o){this.executeScriptSync(o)}},executeScriptSync:function(o){this.postMessage('executeScriptSync',[o])},executeScript:function(o){this.postMessage('executeScript',[o])},postMessage:function(o,p){var q=this.dom.get(0).contentWindow;q&&q.postMessage(JSON.stringify({type:o,message:p}),'*')},remove:function(o){delete k[o]},parseAtom:function(o){var p=/^([^\s]+)\s+([^\s]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)/,q=p.exec(o);return{id:q[2],label:q[1],x:q[3],y:q[4],z:q[5]}},_doHighlights:function(o){if(this.lastHoveredAtom){if(this.lastHoveredAtom.label===o.label)return void this._undoHighlightsDebounced();f.highlightId(this.lastHoveredAtom.label,0)}this._undoHighlights(),f.highlightId(o.label,1),this.lastHoveredAtom=o,this._undoHighlightsDebounced()},_undoHighlights:function(){j.call(this)},_undoHighlightsDebounced:function(){l.call(this)},_activateHighlights:function(){var o=this;if(this.module.data._highlight){var p=c(this.module.data._highlight).flatten().uniq().value();o._highlighted=[],f.killHighlight(this.module.getId());for(var q=0;q<p.length;q++)(function(r){f.listenHighlight({_highlight:p[r]},function(s,t){Array.isArray(t)&&(t=[t]),o._highlighted=s?c(o._highlighted).push(t).flatten().uniq().value():c.filter(o._highlighted,function(u){return-1===t.indexOf(u)}),o._drawHighlight()},!1,o.module.getId())})(q)}},_drawHighlight:function(){var o='select *.*; halos off;';this._highlighted&&this._highlighted.length&&(o+='select '+this._highlighted.join(',')+'; halos on;'),this.executeScript(o)}});var l=c.debounce(j,250);return h});
