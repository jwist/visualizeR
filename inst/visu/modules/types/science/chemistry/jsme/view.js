'use strict';define(['require','modules/default/defaultview','src/util/api','src/util/ui','src/util/debug'],function(a,b,c,f,g){'use strict';function h(){}var j={};return window.addEventListener('message',function(k){try{var m=JSON.parse(k.data)}catch(p){return}if('jsme'===m.module){var n=m.id;if(!j[n])return void g.error('No view with ID '+n);var o=j[n];switch(m.type){case'ready':o.resolveReady();break;case'onChange':o.module.controller.onChange(m.message);break;case'doHighlight':o._doHighlight(m.message.mol,m.message.atom);break;case'atomHover':o.module.controller.onAtomHover(m.message);break;case'atomClicked':o.module.controller.onAtomClick(m.message);break;case'bondHover':o.module.controller.onBondHover(m.message);break;case'bondClicked':o.module.controller.onBondClick(m.message);break;default:g.error('Message type not handled: ',m.type);}}}),$.extend(!0,h.prototype,b,{init:function(){var m=this,n=this.module.getId();j[n]=this,this.dom=f.getSafeElement('iframe').attr({allowfullscreen:!0,src:a.toUrl('./jsme.html')}),this.module.getDomContent().html(this.dom),this.module.getDomContent().css('overflow','hidden'),this.dom.bind('load',function(){m.postMessage('init',{prefs:m.getPrefs(),highlightColor:m.getHighlightColor(),bondwidth:m.module.getConfiguration('bondwidth'),labelsize:m.module.getConfiguration('labelsize'),defaultaction:m.module.getConfiguration('defaultaction'),id:n})})},setJSMEOptions:function(m){m=Object.assign({},m,{prefs:m.prefs?m.prefs.map((n)=>n+'').join():void 0}),this.postMessage('setOptions',m)},getPrefs:function(){return this.module.getConfiguration('prefs').join()},getHighlightColor:function(){return this.module.getConfiguration('highlightColor','3')},onResize:function(){this.dom.attr('width',this.width),this.dom.attr('height',this.height),this.postMessage('setSize',{width:this.width,height:this.height}),this.refresh()},onProgress:function(){this.dom.html('Progress. Please wait...')},blank:{mol:function(){this._currentValue=null,this._currentType=null,this.postMessage('clear','*')},jme:function(){this._currentValue=null,this._currentType=null,this.postMessage('clear','*')},smiles:function(){this._currentValue=null,this._currentType=null,this.postMessage('clear','*')}},update:{mol:function(m){this._currentValue=m,this._currentType='mol',m.get()&&(this.postMessage('setMolFile',m.get()+''),this._initHighlight(m))},jme:function(m){this._currentValue=m,this._currentType='jme',m.get()&&(this.postMessage('setJmeFile',m.get()+''),this._initHighlight(m))},smiles:function(m){var n=this;this._currentValue=m,this._currentType='smiles',a(['openchemlib/openchemlib-core'],function(o){var p=m.get()+'',q=o.Molecule.fromSmiles(p);n.postMessage('setMolFile',q.toMolfile()),n._initHighlight(m)})}},onActionReceive:{setOptions:function(m){this.setJSMEOptions(m)}},_initHighlight:function(m){var n=this;c.killHighlight(this.module.getId()),c.listenHighlight(m,function(o,p){for(var q=[],r=0,s=p.length;r<s;r++)m._atoms[p[r]]instanceof Array||(m._atoms[p[r]]=[m._atoms[p[r]]]),q=q.concat(m._atoms[p[r]]);n.postMessage('setHighlight',{atoms:q,onOff:o})},!1,this.module.getId())},_doHighlight:function(m,n){if(this._currentValue){for(var o in this._currentValue._atoms)-1<this._currentValue._atoms[o].indexOf(this.highlightedAtom)&&c.highlightId(o,!1);for(var o in this._currentValue._atoms)0!=n&&-1<this._currentValue._atoms[o].indexOf(n-1)&&c.highlightId(o,1);this.highlightedAtom=n-1}},postMessage:function(m,n){var o=this.dom.get(0).contentWindow;o&&o.postMessage(JSON.stringify({type:m,message:n}),'*')},remove:function(m){delete j[m]}}),h});
