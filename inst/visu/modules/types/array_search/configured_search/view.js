'use strict';define(['modules/default/defaultview','src/util/datatraversing','src/util/api','lib/formcreator/formcreator','src/util/util','src/util/debug'],function(Default,Traversing,API,FormCreator,Util,Debug){'use strict';function View(){}return $.extend(!0,View.prototype,Default,{init:function(){var b=this,c=$('<div>').css({position:'relative',height:'100%',weight:'100%'});this.overlay=$('<div>').css({position:'absolute',height:'100%',width:'100%',zIndex:1e3,backgroundColor:'rgba(200,200,200,0)',color:'rgba(50,50,50,0)',display:'none'}).appendTo(c).click(function(q){q.stopPropagation(),b.searchEnabled=!0,b.overlay.animate({backgroundColor:'rgba(200,200,200,0)',color:'rgba(50,50,50,0)'},500,function(){b.overlay.css('display','none')}),b.search()}).append($('<div>'+this.module.getConfiguration('disableMessage')+'</div>').css({textAlign:'center',width:'100%',zIndex:1001,display:'table-cell',verticalAlign:'middle',fontSize:'20pt'})),this.searchEnabled=!0,this.dom=$('<div>').appendTo(c),this.module.getDomContent().html(c),this.variables={},this.cfgValue={},this.maxhits=parseInt(this.module.getConfiguration('maxhits'),10)||Number.POSITIVE_INFINITY,this._jpathsFcts={};for(var d=this.module.getConfiguration('searchfields'),f=this.module.definition.vars_out||[],g=[],h=0,n=f.length,o={sections:{cfg:{groups:{cfg:{options:{type:'list'},fields:FormCreator.makeStructure(d,function(q){for(var r=0,s=q.groups.general[0].searchOnField.length;q.groups.general[0].searchOnField[r];r++)Util.addjPathFunction(b._jpathsFcts,q.groups.general[0].searchOnField[r])})}}}}};h<n;h++)g.push(f[h].name);var p=FormCreator.makeForm();p.init({onValueChanged:function(){var s=p.getValue().sections.cfg[0].groups.cfg[0],t={};for(var u in s)t[u]=s[u][0];$.extend(b.cfgValue,t),b.search()}}),p.setStructure(o),p.onStructureLoaded().done(function(){p.fill({})}),p.onLoaded().done(function(){b.dom.html(p.makeDom(2)),p.inDom(),p.fieldElementValueChanged()}),this.makeSearchFilter(),this.resolveReady()},blank:{value:function(){this.dom.empty()}},search:function(){if(this.searchEnabled){var c,d,n,b=this.cfgValue,f=new DataArray,g=new DataArray,h=Object.keys(this.variables);if(0===h.length||0===Object.keys(b).length)return;var o=this.maxhits,p=0;for(var q in h)for(n=this.variables[h[q]],d=n.length,c=0;c<d;c++)this.searchElement(b,n.getChildSync([c]).get())?(p<o&&(f[p++]=n[c]),g[c]=!0):g[c]=!1;this.module.controller.searchDone(f,g)}},_makeOp:function(b,c,d){c='cfg[ "'+c+'" ]';var f='',g='';d.number&&(f='parseFloat(',g=')');var h='.toLowerCase()';return d.caseSensitive&&(h=''),'='===b||'eq'===b?d.number?' el == '+f+c+g+' ':' ((el+"")'+h+') == '+c+h+' ':'<>'===b||'><'===b||'!='===b?' (el + "") !== '+c+' ':'>'===b?' el > '+f+c+g+' ':'>='===b?' el >= '+f+c+g+' ':'<'===b?' el < '+f+c+g+' ':'<='===b?' el <= '+f+c+g+' ':'contains'===b?' el'+h+'.match('+c+h+') ':'notcontain'===b?' ! el'+h+'.match('+c+h+') ':'starts'===b?' el'+h+'.match(new RegExp("^"+'+c+h+')) ':'end'===b?' el'+h+'.match(new RegExp('+c+h+'+"$")) ':'btw'===b?' ( el >= parseFloat( '+c+'[0] ) && el <= parseFloat( '+c+'[1] ) )':void 0},makeSearchFilter:function(){var searchOn,searchfields=this.module.getConfiguration('searchfields'),i=0,l=searchfields.length,toEval='';for(toEval+=' this._searchFunc = function( cfg, row ) { ',toEval+=' var el; ',toEval+=' return ';i<l;i++){searchOn=searchfields[i].groups.general[0].searchOnField||[],0<i&&(toEval+=' && ');var j=0,k=searchOn.length;if(0<k){for(toEval+=' ( ';j<k;j++){0<j&&(toEval+=' || ');var opts={};'float'===searchfields[i].groups.general[0].type[0]&&(opts.number=!0),searchfields[i].groups.text&&'case_sensitive'===searchfields[i].groups.text[0].case_sensitive[0][0]&&(opts.caseSensitive=!0);var allow_undefined=!1;searchfields[i].groups.general[0].allow_undefined&&searchfields[i].groups.general[0].allow_undefined[0]&&(allow_undefined=!!searchfields[i].groups.general[0].allow_undefined[0].length),toEval+=' ( ( el = this.getJpath( "'+searchOn[j]+'", row ) ) ? ( ',toEval+=this._makeOp(searchfields[i].groups.general[0].operator[0],searchfields[i].groups.general[0].name[0],opts),toEval+=' ) : '+allow_undefined+' ) '}toEval+=' ) '}}toEval+=';};';try{this._searchFunc=null,eval(toEval)}catch(a){Debug.error('Error while evaluating function.',toEval)}},searchElement:function(b,c){return this._searchFunc(b,c)},getJpath:function(b,c){return this._jpathsFcts[b](c)},update:{array:function(b,c){b&&(this.variables[c]=b.get(),this.search())}},onActionReceive:{disable:function(){this.searchEnabled&&(this.searchEnabled=!1,this.overlay.css('display','table'),this.overlay.animate({backgroundColor:'rgba(200,200,200,0.6)',color:'rgba(50,50,50,1)'},500))}}}),View});
