'use strict';var _Mathceil=Math.ceil,_Mathfloor=Math.floor,_Mathlog=Math.log,_Mathpow=Math.pow;define(function(){function a(b,c,d,e,f){this._nameSpace='http://www.w3.org/2000/svg',this._px='px',this.navigation=f,this.zonesDone=[],this.zoomChangeCallback=$.Callbacks(),this.moveCallback=$.Callbacks(),this._els=[],this._viewBox=[],this._svgEl=document.createElementNS(this._nameSpace,'svg'),this._svgEl.setAttributeNS('http://www.w3.org/2000/xmlns/','xmlns:xlink','http://www.w3.org/1999/xlink'),this._svgEl.setAttribute('draggable','true'),this._svgEl.setAttribute('preserveAspectRatio','xMidYMid meet'),this._groupElements=document.createElementNS(this._nameSpace,'g'),this._svgEl.appendChild(this._groupElements),this._groupLabels=document.createElementNS(this._nameSpace,'g'),this._svgEl.appendChild(this._groupLabels),this.navigation&&(this.navRect=document.createElementNS(this._nameSpace,'rect'),this.navRect.setAttribute('stroke','red'),this.navRect.setAttribute('fill','none'),this._svgEl.appendChild(this.navRect))}return a.prototype.create=function(){this.deltaZoom(0,0,0),this._setEvents()},a.prototype.remove=function(){this._svgEl.parentElement.removeChild(this._svgEl)},a.prototype.setViewBoxWidth=function(b,c,d,e){this._viewWidth=d,this._viewHeight=e,this._viewBox=[b,c,this._viewWidth,this._viewHeight],this.zones=[],this.initZoom()},a.prototype.onZoomChange=function(b){this.zoomChangeCallback.add(b)},a.prototype.onMove=function(b){this.moveCallback.add(b)},a.prototype.setSize=function(b,c){this._width=b,this._height=c,this._svgEl.setAttribute('width',b+this._px),this._svgEl.setAttribute('height',c+this._px),this.initZoom()},a.prototype.initZoom=function(){if(this._viewBox[2]){var b=this._width/this._viewBox[2],c=this._height/this._viewBox[3],d=Math.min(c,b);if(this._zoom=d,this._izoom=d,this._zoomMode=d==c?'y':'x','y'==this._zoomMode){if(!this._width)return;this._viewBox[2]=this._width/c,this._viewWidth=this._viewBox[2]}else{if(!this._height)return;this._viewBox[3]=this._height/b,this._viewHeight=this._viewBox[3]}this.setViewBox(!0)}},a.prototype.bindTo=function(b){this._wrapper=b},a.prototype.ready=function(){$(this._wrapper).append(this._svgEl),this.setViewBox(!0);var b=$(this._svgEl).offset(),c=this;$(this._svgEl).on('mouseenter','[class=highlightgroup]',function(){var d=$(this).data('id');c._els[d].mouseover()}).on('mouseout','[class=highlightgroup]',function(){var d=$(this).data('id');c._els[d].mouseout()}),this._svgPosX=b.left,this._svgPosY=b.top,this.doZones()},a.prototype._setEvents=function(){if(!this.navigation){var b=this;$(this._svgEl).mousewheel(function(c,d){return b.deltaZoom((c.pageX-b._svgPosX)/b._width,(c.pageY-b._svgPosY)/b._height,d),!1}),this._svgEl.addEventListener('mousedown',function(c){b._dragStart(c)}),this._svgEl.addEventListener('mouseup',function(c){b._dragStop(c)}),this._svgEl.addEventListener('mousemove',function(c){b._dragMove(c)})}},a.prototype._dragStart=function(b){this._dragging=!0,this._dragX=b.pageX,this._dragY=b.pageY},a.prototype._dragMove=function(b){if(this._dragging){var c=b.pageX,d=c-this._dragX,e=b.pageY,f=e-this._dragY,g=d/this._zoom,l=f/this._zoom;this._viewBox[0]-=g,this._viewBox[1]-=l,this.moveCallback.fire(this._viewBox[0]+this._viewBox[2]/2,this._viewBox[1]+this._viewBox[3]/2),this._dragX=c,this._dragY=e,this.setViewBox(),this.doZones()}},a.prototype.setCenter=function(b,c){this._viewBox[0]=b-this._viewBox[2]/2,this._viewBox[1]=c-this._viewBox[3]/2,this.setViewBox(),this.navigation||(this.moveCallback.fire(this._viewBox[0]+this._viewBox[2]/2,this._viewBox[1]+this._viewBox[3]/2),this.doZones())},a.prototype.setZoom=function(b){this.deltaZoom(0.5,0.5,null,_Mathpow(2.71828182846,3.68887945411394*b-0.693147180559945)*this._izoom)},a.prototype._dragStop=function(){this._dragging=!1},a.prototype.deltaZoom=function(b,c,d,e){if(null!==d){1<=Math.abs(d)&&(d=0>d?-0.5:0.25),this._currentDelta||(this._currentDelta=0,this._accumulatedDelta=0);this._svgEl.parentNode;this._currentDelta+=d}else{if(d=0,this._zoom=e,'y'==this._zoomMode){var g=this._height/this._zoom;this._currentDelta=_Mathlog(g/this._viewHeight)/0.6931471805599453}else{var l=this._width/this._zoom;this._currentDelta=_Mathlog(l/this._viewWidth)/0.6931471805599453}if(isNaN(this._currentDelta))return void(this._currentDelta=0)}var l=this._viewWidth*_Mathpow(2,this._currentDelta),g=this._viewHeight*_Mathpow(2,this._currentDelta),m='y'==this._zoomMode?this._height/g:this._width/l;return 0.5>m/this._izoom?void(this._currentDelta-=d):20<m/this._izoom?void(this._currentDelta-=d):void(this._zoom=m,this._viewBox[0]-=b*(l-this._viewBox[2]),this._viewBox[1]-=c*(g-this._viewBox[3]),this._viewBox[2]=l,this._viewBox[3]=g,this.setViewBox(),this.navigation||(this.moveCallback.fire(this._viewBox[0]+this._viewBox[2]/2,this._viewBox[1]+this._viewBox[3]/2),this.zoomChangeCallback.fire((_Mathlog(this._zoom/this._izoom)+0.693147180559945)/3.68887945411394),this.changeZoomElements(this._zoom),this.timeSpringUpdate(200)))},a.prototype.timeSpringUpdate=function(b){window.clearTimeout(this._timeoutZoom),this._timeoutZoom=window.setTimeout(function(){},b)},a.prototype.getViewBox=function(){return this._viewBox},a.prototype.setViewBox=function(b,c,d,e,f){c&&e&&d&&f&&(this._viewBox=[c,d,e,f]),this.navigation&&!b?(this.navRect.setAttribute('x',this._viewBox[0]),this.navRect.setAttribute('y',this._viewBox[1]),this.navRect.setAttribute('width',this._viewBox[2]),this.navRect.setAttribute('height',this._viewBox[3])):this._svgEl.setAttributeNS(null,'viewBox',this._viewBox.join(' '))},a.prototype.doZones=function(){var b=_Mathfloor(20*this._viewBox[0]/this._viewWidth)-2,c=_Mathfloor(20*this._viewBox[1]/this._viewHeight)-2,d=_Mathceil(20*this._viewBox[2]/this._viewWidth)+2,e=_Mathceil(20*this._viewBox[3]/this._viewWidth)+2;this._zoneMinX=b,this._zoneMinY=c,this._zoneNbX=d,this._zoneNbY=e;for(var f=0;f<=d;f++)for(var l,g=0;g<=e;g++)if(l=1e3*(f+b)+g+c,!this.zonesDone[l]){if(this.zones[f+b]&&this.zones[f+b][g+c])for(var m=0;m<this.zones[f+b][g+c].length;m++)this.zones[f+b][g+c][m].changeZoom(this._zoom);this.zonesDone[l]=!0}},a.prototype.changeZoomElements=function(b){this._zoom=b,this.zonesDone=[],this.doZones()},a.prototype.add=function(b){this._els.push(b);var c=b.getX(),d=b.getY(),e=_Mathfloor(20*c/this._viewWidth),f=_Mathfloor(20*d/this._viewHeight);if(this.zones[e]=this.zones[e]||[],this.zones[e][f]=this.zones[e][f]||[],this.zones[e][f].push(b),b.id=this._els.length-1,b.zoneIndexX=e,b.zoneIndexY=f,!!b._nodes){for(var g in b._nodes)this._groupElements.appendChild(b._nodes[g]);b._label&&this._groupLabels.appendChild(b._label),b.inDom()}},a.prototype.getElementsForSprings=function(){this._zoneNbX=20,this._zoneNbY=20,this._zoneMinX=0,this._zoneMinY=0;for(var d,b=[],c=[],e=0;e<=this._zoneNbX;e++)for(var f=0;f<=this._zoneNbY;f++)if(this.zones[e+this._zoneMinX]&&this.zones[e+this._zoneMinX][f+this._zoneMinY])for(var g=0;g<this.zones[e+this._zoneMinX][f+this._zoneMinY].length;g++)(d=this.zones[e+this._zoneMinX][f+this._zoneMinY][g].getCoordsSprings(b))&&c.push(d);return[b,c]},a});
